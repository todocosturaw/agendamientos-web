<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reservas | Todo Costura</title>
  <meta name="description" content="Seleccion√° un turno y complet√° los datos para confirmar tu inscripci√≥n." />
  <meta name="theme-color" content="#ffffff" />

  <style>
    :root{
      --brand:#a52b64;

      --bg:#ffffff;
      --surface:#ffffff;
      --txt:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;

      --soft:#f6f7fb;
      --soft2:#f3f4f6;

      --r:18px;
      --r2:22px;

      --shadow: 0 18px 55px rgba(17,24,39,.10);
      --shadow2: 0 10px 25px rgba(17,24,39,.08);

      --focus: 0 0 0 4px rgba(165,43,100,.14);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      background: linear-gradient(180deg, #ffffff 0%, #ffffff 60%, #fbfbfd 100%);
      color: var(--txt);
    }

    .wrap{max-width:1180px;margin:0 auto;padding:28px 18px 40px}

    /* Header */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      margin-bottom:22px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;align-items:center;gap:12px;min-width:240px;
    }
    .logoBox{
      width:44px;height:44px;border-radius:14px;
      border:1px solid rgba(165,43,100,.18);
      background: rgba(165,43,100,.06);
      display:grid;place-items:center;
      overflow:hidden;
      flex:0 0 auto;
    }
    .logoBox img{width:100%;height:100%;object-fit:cover;display:block}
    .brandText{
      display:flex;flex-direction:column;line-height:1.2;
    }
    .brandText .name{
      font-weight:900;
      letter-spacing:.2px;
      font-size:14px;
    }
    .brandText .tag{
      color:var(--muted);
      font-size:12.5px;
      margin-top:4px;
    }

    .statusPill{
      display:inline-flex;align-items:center;gap:10px;
      padding:9px 12px;border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      box-shadow: 0 10px 18px rgba(17,24,39,.06);
      color:var(--muted);
      font-size:12.5px;
      white-space:nowrap;
    }
    .dot{width:9px;height:9px;border-radius:99px;background:rgba(165,43,100,.40);box-shadow: 0 0 0 4px rgba(165,43,100,.10)}

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:26px;
      align-items:start;
    }
    @media (max-width:980px){
      .grid{grid-template-columns:1fr;gap:18px}
    }

    /* Left: hero */
    .hero{padding:12px 0}
    .hero h1{
      margin:8px 0 10px 0;
      font-size:44px;
      line-height:1.05;
      letter-spacing:-.6px;
      font-weight:950;
    }
    .hero h1 .accent{color:var(--brand)}
    .hero p{
      margin:0;
      color:var(--muted);
      font-size:15.5px;
      line-height:1.6;
      max-width:54ch;
    }
    .heroNote{
      margin-top:18px;
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
      color:var(--muted);
      font-size:12.5px;
    }
    .chip{
      display:inline-flex;align-items:center;
      padding:7px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      box-shadow: 0 10px 18px rgba(17,24,39,.05);
      gap:8px;
    }
    .chip .miniDot{
      width:7px;height:7px;border-radius:99px;background:rgba(165,43,100,.45);
      box-shadow: 0 0 0 4px rgba(165,43,100,.10);
    }

    /* Left: service info card (table) */
    .serviceCard{
      margin-top:22px;
      border:1px solid var(--line);
      border-radius:22px;
      background:#fff;
      box-shadow: var(--shadow2);
      overflow:hidden;
      max-width: 560px;
    }
    .serviceHead{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, #ffffff, #fbfbfd);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .serviceHead .h{
      font-weight:950;
      font-size:13px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:#374151;
    }
    .serviceHead .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(165,43,100,.18);
      background: rgba(165,43,100,.06);
      color:#7a1f4a;
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
    }
    .infoTable{width:100%;border-collapse:collapse}
    .infoTable td{
      padding:11px 16px;
      border-bottom:1px solid #f0f2f6;
      vertical-align:top;
      font-size:13.5px;
    }
    .infoTable tr:last-child td{border-bottom:0}
    .infoTable td.k{width:42%;color:#4b5563;font-weight:800}
    .infoTable td.v{color:#111827;font-weight:700}
    .infoTable .mutedv{color:var(--muted);font-weight:700}

    .priceBig{font-size:16px;font-weight:950}
    .priceSub{margin-top:2px;font-size:12.5px;color:var(--muted);font-weight:700}
    .priceSub strong{color:#111827;font-weight:900}
    .badgeOk{
      display:inline-flex;align-items:center;
      padding:3px 8px;border-radius:999px;
      border:1px solid rgba(10,122,47,.18);
      background: rgba(10,122,47,.08);
      color:#0a7a2f;
      font-weight:900;
      font-size:11.5px;
      margin-left:8px;
    }

    /* Right: card */
    .card{
      background: var(--surface);
      border:1px solid var(--line);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:18px 18px 14px 18px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, #ffffff, #fbfbfd);
    }
    .cardHead .title{
      margin:0;
      font-size:14px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:#374151;
      font-weight:950;
    }
    .cardHead .sub{
      margin:8px 0 0 0;
      color:var(--muted);
      font-size:13.5px;
      line-height:1.45;
    }
    .cardBody{padding:16px 18px 18px}

    .section{margin-top:14px}
    .section:first-child{margin-top:0}
    .section h3{
      margin:0 0 10px 0;
      font-size:13px;
      color:#374151;
      font-weight:900;
    }

    .muted{color:var(--muted)}
    .tiny{font-size:12.5px}

    /* Fields */
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .field{flex:1 1 220px;min-width:210px}
    label{
      display:block;
      margin:10px 0 6px 0;
      font-size:12.5px;
      color:#4b5563;
      font-weight:700;
    }
    input[type="text"], input[type="email"], input[type="number"], select, textarea{
      width:100%;
      padding:11px 12px;
      border:1px solid var(--line);
      border-radius:14px;
      outline:none;
      background:#fff;
      color:var(--txt);
      font-size:14px;
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    textarea{min-height:86px;resize:vertical}
    input:focus, select:focus, textarea:focus{
      border-color: rgba(165,43,100,.55);
      box-shadow: var(--focus);
    }
    input:disabled, select:disabled, textarea:disabled{
      background: #f8fafc;
      color:#9ca3af;
      cursor:not-allowed;
    }

    /* Slots list */
    .slots{display:flex;flex-direction:column;gap:10px}
    .slot{
      display:flex;gap:10px;align-items:flex-start;
      padding:12px 12px;
      border:1px solid var(--line);
      border-radius:16px;
      background:#fff;
      transition: border-color .15s ease, box-shadow .15s ease, transform .08s ease;
    }
    .slot:hover{
      border-color: rgba(165,43,100,.22);
      box-shadow: var(--shadow2);
      transform: translateY(-1px);
    }
    .slot input{margin-top:2px}
    .slot label{margin:0;color:var(--txt);font-weight:900;font-size:13.5px}
    .slot .meta{margin-top:4px;color:var(--muted);font-size:12.5px;line-height:1.35;display:flex;gap:8px;flex-wrap:wrap}
    .kpi{
      display:inline-flex;align-items:center;
      padding:4px 10px;border-radius:999px;
      border:1px solid rgba(165,43,100,.20);
      background: rgba(165,43,100,.06);
      color:#7a1f4a;
      font-weight:900;
      font-size:12px;
    }
    .kpi.gray{
      border-color: rgba(107,114,128,.25);
      background: rgba(107,114,128,.08);
      color:#4b5563;
    }
    .slot.disabled{opacity:.55;background:#fcfcfe}
    .slot.disabled:hover{box-shadow:none;transform:none;border-color: var(--line)}

    /* Participant blocks */
    .pbox{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background: #fff;
      margin-top:10px;
    }
    .pboxTitle{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin-bottom:8px;
    }
    .pboxTitle .left{
      display:flex;align-items:center;gap:8px;
      font-weight:900;color:#374151;font-size:13px;
    }
    .idx{
      width:26px;height:26px;border-radius:10px;
      display:grid;place-items:center;
      background: rgba(165,43,100,.08);
      border:1px solid rgba(165,43,100,.18);
      color:#7a1f4a;
      font-weight:950;
      font-size:12px;
    }

    /* Buttons */
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{
      border:0;border-radius:14px;cursor:pointer;
      padding:11px 14px;font-weight:950;font-size:13.5px;
      transition: transform .08s ease, box-shadow .15s ease, opacity .15s ease;
    }
    button:active{transform: translateY(1px)}
    button:disabled{opacity:.55;cursor:not-allowed;transform:none}
    .primary{
      background: var(--brand);
      color:#fff;
      box-shadow: 0 16px 35px rgba(165,43,100,.20);
    }
    .primary:hover{box-shadow: 0 18px 40px rgba(165,43,100,.24)}
    .ghost{
      background:#fff;border:1px solid var(--line);color:var(--txt);
      box-shadow: 0 12px 22px rgba(17,24,39,.06);
    }

    /* Messages */
    .msg{margin-top:10px;font-size:13px;line-height:1.35}
    .err{color:#b00020;font-weight:800}
    .ok{color:#0a7a2f;font-weight:800}

    /* Loading overlay */
    .loading{
      position:fixed;inset:0;
      background: rgba(255,255,255,.92);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
      z-index:9999;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }
    .loadCard{
      width:min(640px, 92vw);
      background:#fff;
      border:1px solid var(--line);
      border-radius:24px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .loadTop{
      padding:18px 18px 14px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      background: linear-gradient(180deg, #ffffff, #fbfbfd);
    }
    .loadTop .left{display:flex;align-items:center;gap:12px}
    .spinner{
      width:36px;height:36px;border-radius:99px;
      border:3px solid rgba(165,43,100,.15);
      border-top-color: rgba(165,43,100,.85);
      animation: spin 1s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .loadTitle{
      display:flex;flex-direction:column;gap:4px;
    }
    .loadTitle strong{font-weight:950;font-size:14px;color:#111827}
    .loadTitle span{font-size:12.5px;color:var(--muted)}
    .progressWrap{padding:16px 18px 18px}
    .bar{
      height:10px;border-radius:999px;background: var(--soft2);
      overflow:hidden;border:1px solid var(--line);
    }
    .bar > div{
      height:100%;
      width:30%;
      background: linear-gradient(90deg, rgba(165,43,100,.20), rgba(165,43,100,.75));
      border-radius:999px;
      transition: width .25s ease;
    }
    .skel{
      margin-top:14px;
      display:grid;gap:10px;
    }
    .skel .line{
      height:12px;border-radius:999px;
      background: linear-gradient(90deg, #f3f4f6 0%, #eceef3 45%, #f3f4f6 100%);
      background-size: 200% 100%;
      animation: shimmer 1.2s ease-in-out infinite;
      border:1px solid #eef0f5;
    }
    .skel .line.w60{width:60%}
    .skel .line.w80{width:80%}
    .skel .line.w95{width:95%}
    @keyframes shimmer{
      0%{background-position: 200% 0}
      100%{background-position: -200% 0}
    }

    /* ======= NUEVO: intenci√≥n + temporizador hold ======= */
    .intentRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:6px;
    }
    .toggle{
      display:flex;gap:10px;flex-wrap:wrap;
      padding:10px 10px;
      border:1px solid var(--line);
      border-radius:16px;
      background:#fff;
      box-shadow: 0 10px 18px rgba(17,24,39,.05);
    }
    .topt{
      display:flex;align-items:center;gap:8px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:#fff;
      cursor:pointer;
      user-select:none;
      font-weight:900;
      font-size:12.5px;
      color:#374151;
    }
    .topt input{margin:0}
    .holdBar{
      margin-top:10px;
      padding:10px 12px;
      border:1px solid rgba(165,43,100,.20);
      border-radius:16px;
      background: rgba(165,43,100,.06);
      display:none;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .holdBar strong{color:#7a1f4a}
    .holdTimer{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(165,43,100,.25);
      background:#fff;
      font-weight:950;
      color:#111827;
      font-size:12.5px;
      white-space:nowrap;
    }
    .holdTimer.warn{
      border-color: rgba(176,0,32,.25);
      background: rgba(176,0,32,.06);
      color:#8a0019;
    }
    .linkBtn{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:900;
      font-size:12.5px;
    }
  </style>
</head>

<body>
  <!-- Pantalla de carga -->
  <div class="loading" id="loading">
    <div class="loadCard" role="status" aria-live="polite">
      <div class="loadTop">
        <div class="left">
          <div class="spinner" aria-hidden="true"></div>
          <div class="loadTitle">
            <strong id="loadTitle">Cargando informaci√≥n del curso‚Ä¶</strong>
            <span id="loadSub">Conectando con el sistema.</span>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:10px">
          <div class="logoBox" style="width:40px;height:40px;border-radius:14px">
            <img id="logoImg2" alt="Todo Costura" src="" style="display:none">
            <div id="logoFallback2" style="font-weight:950;color:var(--brand);font-size:12px">TC</div>
          </div>
        </div>
      </div>
      <div class="progressWrap">
        <div class="bar" aria-hidden="true"><div id="loadBar"></div></div>
        <div class="skel" aria-hidden="true">
          <div class="line w80"></div>
          <div class="line w95"></div>
          <div class="line w60"></div>
          <div class="line w95" style="height:40px;border-radius:18px"></div>
          <div class="line w80" style="height:40px;border-radius:18px"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logoBox">
          <img id="logoImg" alt="Todo Costura" src="" style="display:none">
          <div id="logoFallback" style="font-weight:950;color:var(--brand);font-size:12px">TC</div>
        </div>
        <div class="brandText">
          <div class="name">Todo Costura</div>
          <div class="tag">Agenda ¬∑ Inscripci√≥n</div>
        </div>
      </div>

      <div class="statusPill" id="status">
        <span class="dot" aria-hidden="true"></span>
        <span>Inicializando‚Ä¶</span>
      </div>
    </div>

    <div class="grid">
      <div class="hero">
        <h1>Reserv√° tu <span class="accent">turno</span> en segundos.</h1>
        <p>Seleccion√° un turno disponible y complet√° los datos. El sistema bloquea cupos por 20 minutos al iniciar la compra y sincroniza disponibilidad en tiempo real.</p>

        <div class="heroNote">
          <span class="chip"><span class="miniDot"></span> Tiempo real</span>
          <span class="chip"><span class="miniDot"></span> Hold 20 minutos</span>
          <span class="chip"><span class="miniDot"></span> Verificaci√≥n RUC</span>
        </div>

        <!-- Tabla de info del servicio -->
        <div class="serviceCard" id="serviceCard" style="display:none">
          <div class="serviceHead">
            <div class="h">Detalles del curso</div>
            <div class="pill" id="serviceTypePill">‚Äî</div>
          </div>

          <table class="infoTable" role="presentation">
            <tr><td class="k">Curso</td><td class="v" id="svcName">‚Äî</td></tr>
            <tr><td class="k">Categor√≠a</td><td class="v mutedv" id="svcCategory">‚Äî</td></tr>
            <tr><td class="k">Modalidad</td><td class="v mutedv" id="svcLearning">‚Äî</td></tr>
            <tr><td class="k">Plataforma</td><td class="v mutedv" id="svcPlatform">‚Äî</td></tr>
            <tr><td class="k">Tutor</td><td class="v mutedv" id="svcTutor">‚Äî</td></tr>
            <tr>
              <td class="k">Precio</td>
              <td class="v">
                <div class="priceBig" id="svcUnitPrice">‚Äî</div>
                <div class="priceSub" id="svcDiscountLine" style="display:none">‚Äî</div>
                <div class="priceSub" id="svcTotalLine">‚Äî</div>
              </td>
            </tr>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="cardHead">
          <div class="title">Formulario de inscripci√≥n</div>
          <div class="sub">Eleg√≠ si solo quer√©s ver horarios o si vas a comprar. Si compr√°s, al seleccionar asientos se bloquean por 20 minutos.</div>
        </div>

        <div class="cardBody">

          <!-- ======= NUEVO: intenci√≥n ======= -->
          <div class="section">
            <h3>¬øQu√© deseas hacer?</h3>
            <div class="intentRow">
              <div class="toggle" role="group" aria-label="Intenci√≥n">
                <label class="topt">
                  <input type="radio" name="intent" value="view" checked>
                  Solo ver horarios
                </label>
                <label class="topt">
                  <input type="radio" name="intent" value="buy">
                  Comprar curso
                </label>
              </div>
              <div class="muted tiny" id="intentHint">Pod√©s ver cupos en tiempo real. Para comprar, eleg√≠ ‚ÄúComprar curso‚Äù.</div>
            </div>

            <!-- ======= NUEVO: barra hold ======= -->
            <div class="holdBar" id="holdBar">
              <div>
                <strong>Reserva temporal activa</strong>
                <div class="tiny muted" id="holdText">‚Äî</div>
              </div>
              <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                <div class="holdTimer" id="holdTimer">20:00</div>
                <button class="linkBtn" id="btnRelease" type="button">Liberar</button>
              </div>
            </div>
          </div>

          <div class="section">
            <h3>Turnos disponibles</h3>
            <div id="slots" class="slots"></div>
            <div id="slotsHelp" class="muted tiny" style="margin-top:8px"></div>
          </div>

          <div class="section">
            <h3>Participantes</h3>
            <div class="row">
              <div class="field">
                <label for="qty">Cantidad de participantes / asientos</label>
                <input id="qty" type="number" min="1" step="1" value="1" disabled>
                <div id="qtyHint" class="muted tiny"></div>
              </div>
              <div style="min-width:190px;flex:0 0 auto">
                <label>&nbsp;</label>
                <button id="btnBuild" class="ghost" disabled>A√±adir participantes</button>
              </div>
            </div>

            <div id="namesWrap"></div>
          </div>

          <div class="section">
            <h3>Facturaci√≥n</h3>
            <div class="row">
              <div class="field">
                <label for="billName">Raz√≥n social / Nombre *</label>
                <input id="billName" type="text" placeholder="Ej: Juan P√©rez / Todo Costura S.A." disabled>
              </div>
              <div class="field">
                <label for="billDocType">Tipo de documento *</label>
                <select id="billDocType" disabled>
                  <option value="personal" selected>Documento personal (C√©dula)</option>
                  <option value="fiscal">Documento fiscal (RUC)</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div class="field">
                <label id="billDocLabel" for="billDocNumber">Documento personal (C√©dula) *</label>
                <input id="billDocNumber" type="text" placeholder="Ej: 1234567" disabled>
                <div class="tiny muted" id="rucHint" style="margin-top:6px"></div>
              </div>
              <div class="field">
                <label for="billEmail">Correo de facturaci√≥n *</label>
                <input id="billEmail" type="email" placeholder="facturacion@dominio.com" disabled>
              </div>
            </div>

            <div class="row">
              <div class="field">
                <label for="billPhone">Tel√©fono (opcional)</label>
                <input id="billPhone" type="text" placeholder="+595‚Ä¶" disabled>
              </div>
              <div class="field">
                <label for="billAddress">Direcci√≥n *</label>
                <input id="billAddress" type="text" placeholder="Calle, n√∫mero, barrio" disabled>
              </div>
            </div>

            <div class="row">
              <div class="field">
                <label for="billCity">Ciudad *</label>
                <input id="billCity" type="text" placeholder="Ej: Asunci√≥n" disabled>
              </div>
            </div>
          </div>

          <div class="section">
            <h3>Comprobante de pago</h3>
            <div class="row">
              <div class="field">
                <label for="payFile">Adjuntar comprobante (JPG/PNG/PDF) *</label>
                <input id="payFile" type="file" accept="image/*,application/pdf" disabled>
              </div>
              <div class="field">
                <label>Estado</label>
                <div id="payFileStatus" class="muted tiny" style="padding:11px 12px;border:1px dashed var(--line);border-radius:14px;background:#fff">Sin archivo</div>
              </div>
            </div>
          </div>

          <div class="section">
            <h3>Confirmaci√≥n</h3>
            <div class="btns">
              <button id="btnConfirm" class="primary" disabled>Confirmar y enviar</button>
            </div>

            <div id="formMsg" class="msg"></div>
            <div id="sendMsg" class="msg"></div>
            <pre id="debug" style="display:none;"></pre>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // =====================
  // Config
  // =====================
  const API_BASE = "https://api.taller2.workers.dev";

  const RESERVA_ENDPOINT   = `${API_BASE}/api/reserva`;
  const HOLD_ENDPOINT      = `${API_BASE}/api/hold`;
  const RELEASE_ENDPOINT   = `${API_BASE}/api/release`;
  const CONFIRM_ENDPOINT   = `${API_BASE}/api/confirmar`;
  const DNIT_ENDPOINT      = `${API_BASE}/api/dnit`;

  const MAX_FILE_BYTES = 5 * 1024 * 1024; // 5MB
  const HOLD_MS = 20 * 60 * 1000;

  // Logo (opcional)
  const LOGO_URL = ""; // ej: "./logo-todocostura.png"

  // =====================
  // DOM
  // =====================
  const statusEl = document.getElementById("status");
  const slotsEl = document.getElementById("slots");
  const slotsHelpEl = document.getElementById("slotsHelp");
  const debugEl = document.getElementById("debug");

  const qtyEl = document.getElementById("qty");
  const qtyHintEl = document.getElementById("qtyHint");
  const btnBuild = document.getElementById("btnBuild");
  const namesWrap = document.getElementById("namesWrap");

  const formMsg = document.getElementById("formMsg");
  const sendMsg = document.getElementById("sendMsg");

  // Billing
  const billNameEl = document.getElementById("billName");
  const billDocTypeEl = document.getElementById("billDocType");
  const billDocLabelEl = document.getElementById("billDocLabel");
  const billDocNumberEl = document.getElementById("billDocNumber");
  const billEmailEl = document.getElementById("billEmail");
  const billPhoneEl = document.getElementById("billPhone");
  const billAddressEl = document.getElementById("billAddress");
  const billCityEl = document.getElementById("billCity");
  const rucHintEl = document.getElementById("rucHint");

  // Payment proof
  const payFileEl = document.getElementById("payFile");
  const payFileStatusEl = document.getElementById("payFileStatus");

  // Confirm
  const btnConfirm = document.getElementById("btnConfirm");

  // Loading
  const loadingEl = document.getElementById("loading");
  const loadTitleEl = document.getElementById("loadTitle");
  const loadSubEl = document.getElementById("loadSub");
  const loadBarEl = document.getElementById("loadBar");

  // Logos
  const logoImg = document.getElementById("logoImg");
  const logoFallback = document.getElementById("logoFallback");
  const logoImg2 = document.getElementById("logoImg2");
  const logoFallback2 = document.getElementById("logoFallback2");

  // Service info (left)
  const serviceCardEl = document.getElementById("serviceCard");
  const serviceTypePillEl = document.getElementById("serviceTypePill");
  const svcNameEl = document.getElementById("svcName");
  const svcCategoryEl = document.getElementById("svcCategory");
  const svcLearningEl = document.getElementById("svcLearning");
  const svcPlatformEl = document.getElementById("svcPlatform");
  const svcTutorEl = document.getElementById("svcTutor");
  const svcUnitPriceEl = document.getElementById("svcUnitPrice");
  const svcDiscountLineEl = document.getElementById("svcDiscountLine");
  const svcTotalLineEl = document.getElementById("svcTotalLine");

  // Intent + Hold
  const intentHintEl = document.getElementById("intentHint");
  const holdBarEl = document.getElementById("holdBar");
  const holdTextEl = document.getElementById("holdText");
  const holdTimerEl = document.getElementById("holdTimer");
  const btnReleaseEl = document.getElementById("btnRelease");

  // =====================
  // State
  // =====================
  let STATE = {
    course_id: null,
    course: null,
    slots: [],
    selected_slot: null,

    disponibilidad_id: null,     // üëà clave para inventario compartido
    available_rt: null,          // cupos en tiempo real (por disponibilidad)

    intent: "view",              // "view" | "buy"
    client_id: null,

    hold: null,                  // { hold_id, expires_at, qty }
    hold_timer: null,            // interval id

    ws: null,

    payment_proof: null,         // {filename,mime_type,size_bytes,base64}
    ruc_verified: false,
    ruc_tipo_entidad: ""
  };

  // =====================
  // Helpers
  // =====================
  function htmlEscape(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function setStatus(text){
    statusEl.innerHTML = `<span class="dot" aria-hidden="true"></span><span>${htmlEscape(text)}</span>`;
  }

  function setMsg(html, cls){
    formMsg.className = "msg " + (cls || "");
    formMsg.innerHTML = html || "";
  }

  function setSendMsg(html, cls){
    sendMsg.className = "msg " + (cls || "");
    sendMsg.innerHTML = html || "";
  }

  function normalizeInt(x){
    const n = Number(x);
    return Number.isFinite(n) ? Math.trunc(n) : NaN;
  }

  function isEmailBasic(v){
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(v||"").trim());
  }

  function safeCourse(course){
    if (!course || typeof course !== "object") return null;
    return JSON.parse(JSON.stringify(course));
  }

  function getCourseIdFromHash(){
    const h = (location.hash || "").replace(/^#/, "");
    const p = new URLSearchParams(h);
    return p.get("ID") || p.get("course_id");
  }

  function parseISODate(iso){
    const s = String(iso||"").trim();
    const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (!m) return null;
    const y = Number(m[1]), mo = Number(m[2]), d = Number(m[3]);
    if (!y || !mo || !d) return null;
    return new Date(y, mo-1, d);
  }

  function formatDateHuman(iso){
    const d = parseISODate(iso);
    if (!d) return String(iso||"").trim() || "‚Äî";
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yy = d.getFullYear();
    return `${dd}/${mm}/${yy}`;
  }

  function slotSortKey(s){
    const fecha = String(s?.fecha||"").trim();
    const hora = String(s?.hora||"").trim();
    const d = parseISODate(fecha);
    const dayKey = d ? d.getTime() : Number.MAX_SAFE_INTEGER;
    let hmKey = Number.MAX_SAFE_INTEGER;
    const m = hora.match(/^(\d{1,2}):(\d{2})/);
    if (m){
      const hh = Number(m[1]), mm = Number(m[2]);
      if (Number.isFinite(hh) && Number.isFinite(mm)) hmKey = hh*60+mm;
    }
    return [dayKey, hmKey, fecha, hora];
  }

  async function apiGet(url){
    const r = await fetch(url, { method:"GET" });
    const t = await r.text();
    let j=null; try{ j=JSON.parse(t);}catch{}
    return {ok:r.ok, status:r.status, text:t, json:j, url};
  }

  async function apiPost(url, payload){
    const r = await fetch(url, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    const t = await r.text();
    let j=null; try{ j=JSON.parse(t);}catch{}
    return {ok:r.ok, status:r.status, text:t, json:j};
  }

  // =====================
  // Pricing (igual que tu versi√≥n)
  // =====================
  function toNumberFlexible(x){
    if (x === null || x === undefined) return NaN;
    let s = String(x).trim();
    if (!s) return NaN;
    s = s.replace(/[^\d.,-]/g, "");
    if (!s) return NaN;

    const lastComma = s.lastIndexOf(",");
    const lastDot = s.lastIndexOf(".");

    if (lastComma !== -1 && lastDot !== -1){
      const decSep = lastComma > lastDot ? "," : ".";
      const thouSep = decSep === "," ? "." : ",";
      s = s.split(thouSep).join("");
      s = s.replace(decSep, ".");
    } else if (lastComma !== -1 && lastDot === -1){
      s = s.replace(",", ".");
    } else if (lastDot !== -1 && lastComma === -1){
      const parts = s.split(".");
      if (parts.length > 2) s = parts.join("");
    }

    const n = Number(s);
    return Number.isFinite(n) ? n : NaN;
  }

  function moneyFmtPYG(n){
    const isInt = Number.isFinite(n) && Math.abs(n - Math.round(n)) < 1e-9;
    return new Intl.NumberFormat("es-PY", {
      style: "currency",
      currency: "PYG",
      maximumFractionDigits: isInt ? 0 : 2
    }).format(Number.isFinite(n) ? n : 0);
  }

  function getPricingFromCourse(course){
    const tipo = String(course?.tipo_de_curso || "").trim();
    const tipoLower = tipo.toLowerCase();

    const unitList = toNumberFlexible(course?.precio);

    let pct = course?.descuento_pct;
    pct = (pct === null || pct === undefined || pct === "") ? NaN : Number(pct);
    if (!Number.isFinite(pct)) pct = toNumberFlexible(course?.descuento);

    const isFree = /gratuit|gratis/.test(tipoLower) || (Number.isFinite(unitList) && unitList <= 0);
    const effectivePct = (isFree && !Number.isFinite(pct)) ? 100 : pct;

    let unitFinal = unitList;
    if (Number.isFinite(unitList) && Number.isFinite(effectivePct)){
      unitFinal = unitList * (1 - effectivePct/100);
      if (unitFinal < 0) unitFinal = 0;
    }

    const showDiscount = Number.isFinite(effectivePct) && effectivePct > 0;
    return { tipo, unitList, unitFinal, discountPct: effectivePct, showDiscount, isFree };
  }

  function getTutorName(course){
    const t = course?.tutor || null;
    const direct = String(course?.tutor_nombre || "").trim();
    const n = String(t?.nombre || "").trim();
    return direct || n || "‚Äî";
  }

  function renderServiceInfo(){
    const c = STATE.course;
    if (!c){ serviceCardEl.style.display = "none"; return; }

    const name = String(c?.nombre_curso || "Curso").trim();
    const category = String(c?.categoria || "").trim();
    const platform = String(c?.plataforma || "").trim();
    const learning = String(c?.tipo_aprendizaje || "").trim();
    const tutor = getTutorName(c);
    const pricing = getPricingFromCourse(c);

    const q = (() => {
      const v = normalizeInt(qtyEl?.value);
      return (Number.isFinite(v) && v > 0) ? v : 1;
    })();

    const totalList = Number.isFinite(pricing.unitList) ? pricing.unitList * q : NaN;
    const totalFinal = Number.isFinite(pricing.unitFinal) ? pricing.unitFinal * q : NaN;

    serviceTypePillEl.textContent = pricing.tipo || "‚Äî";
    svcNameEl.textContent = name || "‚Äî";
    svcCategoryEl.textContent = category || "‚Äî";
    svcLearningEl.textContent = learning || "‚Äî";
    svcPlatformEl.textContent = platform || "‚Äî";
    svcTutorEl.textContent = tutor;

    if (Number.isFinite(pricing.unitList)){
      if (pricing.isFree || (Number.isFinite(pricing.discountPct) && pricing.discountPct >= 100)){
        svcUnitPriceEl.innerHTML = `Gratis <span class="badgeOk">0</span>`;
      } else {
        svcUnitPriceEl.textContent = `${moneyFmtPYG(pricing.unitList)} por participante`;
      }
    } else {
      svcUnitPriceEl.textContent = "‚Äî";
    }

    if (pricing.showDiscount){
      svcDiscountLineEl.style.display = "block";
      svcDiscountLineEl.innerHTML = `Descuento: <strong>${Number.isFinite(pricing.discountPct) ? pricing.discountPct : 0}%</strong>`;
    } else {
      svcDiscountLineEl.style.display = "none";
    }

    if (pricing.showDiscount && Number.isFinite(totalFinal)){
      svcTotalLineEl.innerHTML = `Total a pagar para ${q} participante(s): <strong>${moneyFmtPYG(totalFinal)}</strong>`;
    } else if (Number.isFinite(totalList)){
      svcTotalLineEl.innerHTML = `Total para ${q} participante(s): <strong>${moneyFmtPYG(totalList)}</strong>`;
    } else {
      svcTotalLineEl.textContent = "Total: ‚Äî";
    }

    serviceCardEl.style.display = "block";
  }

  // =====================
  // Loading UI
  // =====================
  function showLoading(title, sub, progress01){
    loadTitleEl.textContent = title || "Cargando‚Ä¶";
    loadSubEl.textContent = sub || "";
    const p = Math.max(0, Math.min(1, Number(progress01 ?? 0.1)));
    loadBarEl.style.width = Math.round(p * 100) + "%";
    loadingEl.style.display = "flex";
  }
  function hideLoading(){ loadingEl.style.display = "none"; }

  // =====================
  // Logo
  // =====================
  function setupLogo(){
    if (!LOGO_URL) return;

    [logoImg, logoImg2].forEach((img) => { img.src = LOGO_URL; img.style.display = "block"; });
    [logoFallback, logoFallback2].forEach((el) => el.style.display = "none");

    logoImg.onerror = () => { logoImg.style.display="none"; logoFallback.style.display="block"; };
    logoImg2.onerror = () => { logoImg2.style.display="none"; logoFallback2.style.display="block"; };
  }

  // =====================
  // Intent
  // =====================
  function setIntent(intent){
    STATE.intent = intent;

    const buying = (intent === "buy");
    intentHintEl.textContent = buying
      ? "Al seleccionar cantidad se bloquean cupos por 20 minutos."
      : "Modo solo lectura: pod√©s ver cupos en tiempo real sin bloquear.";

    // si cambia a view y hay hold, liberar
    if (!buying && STATE.hold){
      releaseHold("Cambio a solo ver horarios");
    }

    applyUIAccess();
  }

  function applyUIAccess(){
    const buying = (STATE.intent === "buy");

    // Slots se pueden seleccionar siempre, pero si es view no habilitamos pasos de compra
    qtyEl.disabled = !buying || !STATE.selected_slot || !Number.isFinite(STATE.available_rt) || STATE.available_rt <= 0;
    btnBuild.disabled = !buying || qtyEl.disabled;

    // Bloquear secciones de facturaci√≥n/pago hasta que haya hold activo (y modo buy)
    const canFill = buying && !!STATE.hold;

    [billNameEl, billDocTypeEl, billDocNumberEl, billEmailEl, billPhoneEl, billAddressEl, billCityEl, payFileEl].forEach(el=>{
      el.disabled = !canFill;
    });

    btnConfirm.disabled = !isFormValid();

    renderServiceInfo();
  }

  // =====================
  // WebSocket tiempo real
  // =====================
  function wsUrlForDisponibilidad(disponibilidad_id){
    const u = new URL(API_BASE.replace(/^http/,"ws") + "/ws");
    u.searchParams.set("disponibilidad_id", disponibilidad_id);
    return u.toString();
  }

  function connectWS(){
    if (!STATE.disponibilidad_id) return;

    // cerrar anterior si existe
    if (STATE.ws){
      try { STATE.ws.close(); } catch {}
      STATE.ws = null;
    }

    const ws = new WebSocket(wsUrlForDisponibilidad(STATE.disponibilidad_id));
    STATE.ws = ws;

    ws.onopen = () => {
      setStatus("Conectado ¬∑ tiempo real");
    };

    ws.onmessage = (ev) => {
      let msg = null;
      try { msg = JSON.parse(ev.data); } catch {}
      if (!msg) return;

      if (msg.type === "snapshot" || msg.type === "update"){
        if (Number.isFinite(Number(msg.available))) {
          STATE.available_rt = Number(msg.available);
          // refrescar UI de cupos
          renderSlots(STATE.slots);
          applyUIAccess();
        }
      }
    };

    ws.onclose = () => {
      setStatus("Desconectado ¬∑ reintentando‚Ä¶");
      // Reintento simple
      setTimeout(() => {
        if (STATE.disponibilidad_id) connectWS();
      }, 1500);
    };

    ws.onerror = () => { /* onclose har√° retry */ };
  }

  // =====================
  // Slots (mostrar cupo RT por disponibilidad)
  // =====================
  function disableForm(reason){
    qtyEl.disabled = true;
    btnBuild.disabled = true;
    btnConfirm.disabled = true;
    qtyHintEl.textContent = reason || "";
    namesWrap.innerHTML = "";
    setMsg(reason ? `<span class="muted">${htmlEscape(reason)}</span>` : "", "");
    setSendMsg("", "");
    renderServiceInfo();
  }

  function renderSlots(slots){
    slotsEl.innerHTML = "";
    STATE.selected_slot = STATE.selected_slot; // no resetear si cambian cupos

    if (!Array.isArray(slots) || slots.length === 0){
      slotsEl.innerHTML = "<em class='muted'>No hay turnos disponibles.</em>";
      slotsHelpEl.textContent = "";
      return disableForm("No hay turnos disponibles.");
    }

    const available = Number.isFinite(STATE.available_rt) ? STATE.available_rt : null;

    const sorted = slots.slice().sort((a,b)=>{
      const ka = slotSortKey(a);
      const kb = slotSortKey(b);
      for (let i=0;i<ka.length;i++){
        if (ka[i] < kb[i]) return -1;
        if (ka[i] > kb[i]) return 1;
      }
      return 0;
    });

    sorted.forEach((s, idx) => {
      const id = `slot_${idx}`;

      const disp = available; // üëà cupo global por disponibilidad
      const isOk = Number.isFinite(disp) && disp > 0;

      const box = document.createElement("div");
      box.className = "slot" + (isOk ? "" : " disabled");

      const input = document.createElement("input");
      input.type = "radio";
      input.name = "slot";
      input.id = id;
      input.value = String(s.slot_id ?? idx);
      input.disabled = !isOk;

      // mantener seleccionado si corresponde
      const isSelected = STATE.selected_slot && String(STATE.selected_slot.slot_id) === String(s.slot_id);
      if (isSelected) input.checked = true;

      input.addEventListener("change", () => {
        STATE.selected_slot = s;
        onSlotSelected();
      });

      const right = document.createElement("div");
      right.style.flex = "1 1 auto";

      const lab = document.createElement("label");
      lab.htmlFor = id;
      const fechaHuman = formatDateHuman(s.fecha);
      lab.textContent = `${fechaHuman} ¬∑ ${String(s.hora || "‚Äî")}`;
      right.appendChild(lab);

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.innerHTML = `
        <span class="kpi">Cupos: ${htmlEscape(Number.isFinite(disp) ? disp : "-")}</span>
        <span class="kpi gray">${isOk ? "Disponible" : "Sin cupos"}</span>
      `;
      right.appendChild(meta);

      box.appendChild(input);
      box.appendChild(right);
      slotsEl.appendChild(box);
    });

    slotsHelpEl.textContent = "Seleccion√° un turno para continuar.";
    if (!STATE.selected_slot) disableForm("Seleccion√° un turno.");
  }

  function onSlotSelected(){
    const s = STATE.selected_slot;
    if (!s) return disableForm("Seleccion√° un turno.");

    // Cupo global RT
    const disp = Number.isFinite(STATE.available_rt) ? STATE.available_rt : NaN;
    if (!Number.isFinite(disp) || disp <= 0) return disableForm("No hay cupos disponibles.");

    // solo habilitar qty si est√° en modo compra
    if (STATE.intent !== "buy"){
      disableForm("Est√°s en modo solo lectura. Eleg√≠ ‚ÄúComprar curso‚Äù para continuar.");
      return;
    }

    qtyEl.disabled = false;
    qtyEl.min = "1";
    qtyEl.max = String(disp);

    let v = normalizeInt(qtyEl.value);
    if (!Number.isFinite(v) || v < 1) v = 1;
    if (v > disp) v = disp;
    qtyEl.value = String(v);

    qtyHintEl.textContent = `M√°ximo permitido: ${disp}.`;

    // Si hay hold activo, y el usuario cambia slot, lo mantenemos igual porque inventario es global.
    // Si quer√©s forzar selecci√≥n de slot previo a hold, esto es correcto.

    btnBuild.disabled = false;

    const existingBlocks = namesWrap.querySelectorAll('[data-pblock="1"]').length;
    const qty = normalizeInt(qtyEl.value);
    if (existingBlocks && existingBlocks !== qty) buildParticipants();

    // Al seleccionar slot en modo compra, a√∫n NO bloqueamos.
    // Bloqueamos cuando el usuario fija cantidad y se ejecuta createHold().
    renderServiceInfo();
    btnConfirm.disabled = !isFormValid();
    setMsg("", "");
    setSendMsg("", "");
  }

  // =====================
  // Hold (crear / liberar / timer)
  // =====================
  function ensureClientId(){
    if (STATE.client_id) return STATE.client_id;
    const saved = localStorage.getItem("tc_client_id");
    if (saved) { STATE.client_id = saved; return saved; }
    const cid = "c_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
    localStorage.setItem("tc_client_id", cid);
    STATE.client_id = cid;
    return cid;
  }

  function showHoldBar(){
    holdBarEl.style.display = "flex";
  }
  function hideHoldBar(){
    holdBarEl.style.display = "none";
  }

  function formatMMSS(ms){
    const s = Math.max(0, Math.floor(ms/1000));
    const mm = String(Math.floor(s/60)).padStart(2,"0");
    const ss = String(s%60).padStart(2,"0");
    return `${mm}:${ss}`;
  }

  function startHoldTimer(){
    if (!STATE.hold) return;

    if (STATE.hold_timer) clearInterval(STATE.hold_timer);

    const tick = () => {
      if (!STATE.hold) return;
      const left = STATE.hold.expires_at - Date.now();
      holdTimerEl.textContent = formatMMSS(left);
      holdTimerEl.classList.toggle("warn", left <= 2*60*1000);

      if (left <= 0){
        clearInterval(STATE.hold_timer);
        STATE.hold_timer = null;
        // expira: liberar localmente (servidor expira igual, pero avisamos UI)
        STATE.hold = null;
        hideHoldBar();
        applyUIAccess();
        setSendMsg("<span class='err'>Se venci√≥ el tiempo de reserva temporal. Volv√© a seleccionar cantidad.</span>");
      }
    };

    tick();
    STATE.hold_timer = setInterval(tick, 500);
  }

  async function createOrUpdateHold(){
    if (STATE.intent !== "buy") return;
    if (!STATE.disponibilidad_id) return;
    if (!STATE.selected_slot) { setSendMsg("<span class='err'>Seleccion√° un turno.</span>"); return; }

    const qty = normalizeInt(qtyEl.value);
    if (!Number.isFinite(qty) || qty < 1) return;

    // Si ya existe hold, liberar y crear uno nuevo (simple y consistente)
    if (STATE.hold){
      await releaseHold("Actualizar cantidad");
    }

    btnConfirm.disabled = true;
    setSendMsg("<span class='muted'>Reservando cupos temporalmente‚Ä¶</span>");

    const payload = {
      disponibilidad_id: STATE.disponibilidad_id,
      qty,
      client_id: ensureClientId(),
      available_snapshot: Number.isFinite(STATE.available_rt) ? STATE.available_rt : null,
      // opcional para tracking
      course_id: STATE.course_id,
      slot_id: STATE.selected_slot?.slot_id || null
    };

    const res = await apiPost(HOLD_ENDPOINT, payload);
    if (!res.ok || !res.json || res.json.ok !== true){
      setSendMsg(`<span class='err'>No se pudo reservar temporalmente. Cupos disponibles: ${htmlEscape(res.json?.available ?? STATE.available_rt ?? "-")}.</span>`);
      return;
    }

    STATE.hold = { hold_id: res.json.hold_id, expires_at: res.json.expires_at, qty };
    holdTextEl.textContent = `Asientos reservados: ${qty}. Confirm√° antes de que expire.`;
    showHoldBar();
    startHoldTimer();

    setSendMsg("<span class='ok'>Cupos bloqueados. Continu√° con los datos y confirm√°.</span>");
    applyUIAccess();
  }

  async function releaseHold(reason){
    if (!STATE.hold) return;

    const hold_id = STATE.hold.hold_id;
    const client_id = ensureClientId();

    STATE.hold = null;
    hideHoldBar();
    if (STATE.hold_timer) { clearInterval(STATE.hold_timer); STATE.hold_timer = null; }
    applyUIAccess();

    try{
      await apiPost(RELEASE_ENDPOINT, {
        disponibilidad_id: STATE.disponibilidad_id,
        hold_id,
        client_id,
        reason: reason || ""
      });
    } catch {}
  }

  btnReleaseEl.addEventListener("click", async () => {
    await releaseHold("Liberado por usuario");
    setSendMsg("<span class='muted'>Reserva temporal liberada.</span>");
  });

  // =====================
  // Participants (igual con m√≠nimos ajustes)
  // =====================
  function makeField(i, key, labelText, type, required, placeholder){
    const wrap = document.createElement("div");
    wrap.className = "field";

    const lab = document.createElement("label");
    lab.htmlFor = `p${i}_${key}`;
    lab.textContent = labelText + (required ? " *" : "");
    wrap.appendChild(lab);

    const inp = document.createElement("input");
    inp.type = type;
    inp.id = `p${i}_${key}`;
    inp.placeholder = placeholder || "";

    inp.addEventListener("input", () => {
      btnConfirm.disabled = !isFormValid();
      setSendMsg("");
    });

    wrap.appendChild(inp);
    return wrap;
  }

  function buildParticipants(){
    namesWrap.innerHTML = "";

    if (!STATE.selected_slot) return;

    const disp = Number.isFinite(STATE.available_rt) ? STATE.available_rt : NaN;
    const qty = normalizeInt(qtyEl.value);

    if (!Number.isFinite(qty) || qty < 1){
      setMsg("Cantidad inv√°lida.", "err");
      btnConfirm.disabled = true;
      return;
    }
    if (!Number.isFinite(disp) || disp < 1){
      setMsg("Disponibilidad inv√°lida.", "err");
      btnConfirm.disabled = true;
      return;
    }
    if (qty > disp){
      setMsg(`No se pueden registrar ${qty} participantes. Cupos disponibles: ${disp}.`, "err");
      btnConfirm.disabled = true;
      return;
    }

    const note = document.createElement("div");
    note.className = "muted tiny";
    note.style.marginTop = "10px";
    note.textContent = "Complet√° los datos de cada participante (obligatorio: nombres, apellidos, c√©dula, email).";
    namesWrap.appendChild(note);

    for (let i=1;i<=qty;i++){
      const box = document.createElement("div");
      box.className = "pbox";
      box.setAttribute("data-pblock","1");

      const head = document.createElement("div");
      head.className = "pboxTitle";
      head.innerHTML = `<div class="left"><span class="idx">${i}</span> Participante</div>`;
      box.appendChild(head);

      const row = document.createElement("div");
      row.className = "row";

      row.appendChild(makeField(i, "nombres", "Nombres", "text", true, "Ej: Juan Carlos"));
      row.appendChild(makeField(i, "apellidos", "Apellidos", "text", true, "Ej: G√≥mez L√≥pez"));
      row.appendChild(makeField(i, "cedula", "C√©dula", "text", true, "Ej: 1234567"));
      row.appendChild(makeField(i, "email", "Correo", "email", true, "Ej: correo@dominio.com"));
      row.appendChild(makeField(i, "contacto", "Contacto", "text", false, "Ej: +595‚Ä¶"));

      box.appendChild(row);
      namesWrap.appendChild(box);
    }

    renderServiceInfo();
    btnConfirm.disabled = !isFormValid();
    setMsg("", "");
    setSendMsg("", "");
  }

  function getParticipants(){
    const blocks = Array.from(namesWrap.querySelectorAll('[data-pblock="1"]'));
    const out = [];
    for (let idx=0; idx<blocks.length; idx++){
      const i = idx + 1;
      const q = (k) => (namesWrap.querySelector(`#p${i}_${k}`)?.value || "").trim();
      out.push({
        nombres: q("nombres"),
        apellidos: q("apellidos"),
        cedula: q("cedula"),
        email: q("email"),
        contacto: q("contacto") || ""
      });
    }
    return out;
  }

  // =====================
  // Billing + RUC DNIT
  // =====================
  function refreshBillingDocUI(){
    const type = billDocTypeEl.value;
    STATE.ruc_verified = false;
    STATE.ruc_tipo_entidad = "";
    rucHintEl.textContent = "";

    if (type === "fiscal"){
      billDocLabelEl.textContent = "Documento fiscal (RUC) *";
      billDocNumberEl.placeholder = "Ej: 80012345-6";
      rucHintEl.textContent = "Al salir del campo se verificar√° el RUC en DNIT.";
    } else {
      billDocLabelEl.textContent = "Documento personal (C√©dula) *";
      billDocNumberEl.placeholder = "Ej: 1234567";
    }
    btnConfirm.disabled = !isFormValid();
  }

  function getBilling(){
    return {
      razon_social: (billNameEl.value||"").trim(),
      tipo_documento: billDocTypeEl.value,
      documento: (billDocNumberEl.value||"").trim(),
      email: (billEmailEl.value||"").trim(),
      telefono: (billPhoneEl.value||"").trim(),
      direccion: (billAddressEl.value||"").trim(),
      ciudad: (billCityEl.value||"").trim(),
      tipo_entidad: STATE.ruc_tipo_entidad || ""
    };
  }

  function isBillingValid(){
    const b = getBilling();
    if (!b.razon_social) return false;
    if (!b.tipo_documento) return false;
    if (!b.documento) return false;
    if (!b.email || !isEmailBasic(b.email)) return false;
    if (!b.direccion) return false;
    if (!b.ciudad) return false;

    // Si es RUC, debe estar verificado
    if (b.tipo_documento === "fiscal" && !STATE.ruc_verified) return false;

    return true;
  }

  async function verifyRUCIfNeeded(){
    const type = billDocTypeEl.value;
    if (type !== "fiscal") return;

    const ruc = (billDocNumberEl.value || "").trim();
    if (!ruc) { STATE.ruc_verified = false; rucHintEl.textContent = "Ingres√° un RUC v√°lido."; return; }

    rucHintEl.textContent = "Verificando RUC‚Ä¶";
    STATE.ruc_verified = false;
    STATE.ruc_tipo_entidad = "";

    const res = await apiGet(`${DNIT_ENDPOINT}?ruc=${encodeURIComponent(ruc)}`);
    if (!res.ok || !res.json || res.json.ok !== true){
      rucHintEl.textContent = "RUC no verificado. Verific√° el n√∫mero o intent√° nuevamente.";
      STATE.ruc_verified = false;
      btnConfirm.disabled = !isFormValid();
      return;
    }

    // Autocompletar
    const rz = String(res.json.razon_social || "").trim();
    const te = String(res.json.tipo_entidad || "").trim();

    if (rz) billNameEl.value = rz;
    STATE.ruc_tipo_entidad = te;
    STATE.ruc_verified = true;

    rucHintEl.textContent = `RUC verificado${te ? " ¬∑ " + te : ""}.`;
    btnConfirm.disabled = !isFormValid();
  }

  // =====================
  // Payment proof (file)
  // =====================
  function isPaymentProofValid(){
    return Boolean(STATE.payment_proof && STATE.payment_proof.base64);
  }

  function fileToBase64(file){
    return new Promise((resolve, reject)=>{
      const reader = new FileReader();
      reader.onerror = () => reject(new Error("No se pudo leer el archivo"));
      reader.onload = () => {
        const result = String(reader.result || "");
        const idx = result.indexOf("base64,");
        if (idx === -1) return reject(new Error("Formato Base64 inv√°lido"));
        const base64 = result.substring(idx + 7);
        resolve(base64);
      };
      reader.readAsDataURL(file);
    });
  }

  async function handlePaymentFile(file){
    STATE.payment_proof = null;
    payFileStatusEl.textContent = "Procesando‚Ä¶";
    btnConfirm.disabled = true;

    if (!file){
      payFileStatusEl.textContent = "Sin archivo";
      btnConfirm.disabled = !isFormValid();
      return;
    }

    if (file.size > MAX_FILE_BYTES){
      payFileStatusEl.textContent = "Archivo demasiado grande (m√°x. 5 MB)";
      btnConfirm.disabled = true;
      return;
    }

    try{
      const base64 = await fileToBase64(file);
      STATE.payment_proof = {
        filename: file.name,
        mime_type: file.type || "application/octet-stream",
        size_bytes: file.size,
        base64
      };
      payFileStatusEl.textContent = `OK: ${file.name} (${Math.round(file.size/1024)} KB)`;
    } catch(e){
      payFileStatusEl.textContent = `Error: ${e.message}`;
      STATE.payment_proof = null;
    } finally {
      btnConfirm.disabled = !isFormValid();
    }
  }

  // =====================
  // Validation
  // =====================
  function isFormValid(){
    if (STATE.intent !== "buy") return false;
    if (!STATE.selected_slot) return false;
    if (!STATE.hold) return false;

    const disp = Number.isFinite(STATE.available_rt) ? STATE.available_rt : NaN;
    const qty = normalizeInt(qtyEl.value);

    if (!Number.isFinite(disp) || disp < 1) return false;
    if (!Number.isFinite(qty) || qty < 1) return false;

    // la cantidad debe coincidir con el hold
    if (qty !== STATE.hold.qty) return false;

    const participants = getParticipants();
    if (participants.length !== qty) return false;

    for (const p of participants){
      if (!p.nombres) return false;
      if (!p.apellidos) return false;
      if (!p.cedula) return false;
      if (!p.email || !isEmailBasic(p.email)) return false;
    }

    if (!isBillingValid()) return false;
    if (!isPaymentProofValid()) return false;

    // hold no expirado
    if (Date.now() >= STATE.hold.expires_at) return false;

    return true;
  }

  // =====================
  // Payload (incluye disponibilidad_id + hold_id)
  // =====================
  function buildPayload(){
    return {
      meta: {
        source: "web_reservas",
        sent_at_iso: new Date().toISOString()
      },
      course_id: STATE.course_id,
      course: safeCourse(STATE.course),

      disponibilidad_id: STATE.disponibilidad_id,

      slot: {
        slot_id: STATE.selected_slot?.slot_id || null,
        fecha: STATE.selected_slot?.fecha || null,
        hora: STATE.selected_slot?.hora || null,
        cupos_disponibles_snapshot: STATE.available_rt ?? null
      },

      hold: {
        hold_id: STATE.hold?.hold_id || null,
        expires_at: STATE.hold?.expires_at || null,
        qty: STATE.hold?.qty || null,
        client_id: ensureClientId()
      },

      reservation: {
        cantidad_participantes: normalizeInt(qtyEl.value),
        participantes: getParticipants()
      },

      billing: getBilling(),
      payment_proof: STATE.payment_proof
    };
  }

  // =====================
  // Events
  // =====================
  btnBuild.addEventListener("click", (e) => {
    e.preventDefault();
    buildParticipants();
  });

  qtyEl.addEventListener("change", async () => {
    renderServiceInfo();
    // En modo compra: al cambiar cantidad, se crea el hold
    await createOrUpdateHold();
    btnConfirm.disabled = !isFormValid();
  });

  qtyEl.addEventListener("input", () => {
    // limitar por cupo disponible (RT)
    const disp = Number.isFinite(STATE.available_rt) ? STATE.available_rt : NaN;
    let qty = normalizeInt(qtyEl.value);
    if (!Number.isFinite(qty)) qty = 1;
    if (qty < 1) qty = 1;
    if (Number.isFinite(disp) && disp > 0 && qty > disp) qty = disp;
    qtyEl.value = String(qty);

    renderServiceInfo();
    btnConfirm.disabled = !isFormValid();
    setSendMsg("");
  });

  billDocTypeEl.addEventListener("change", refreshBillingDocUI);

  billDocNumberEl.addEventListener("blur", async () => {
    await verifyRUCIfNeeded();
  });

  [billNameEl, billEmailEl, billPhoneEl, billAddressEl, billCityEl].forEach(el=>{
    el.addEventListener("input", ()=>{
      btnConfirm.disabled = !isFormValid();
      setSendMsg("");
    });
  });

  payFileEl.addEventListener("change", async (ev)=>{
    const file = ev.target.files && ev.target.files[0] ? ev.target.files[0] : null;
    await handlePaymentFile(file);
    btnConfirm.disabled = !isFormValid();
    setSendMsg("");
  });

  // Intent radios
  document.querySelectorAll('input[name="intent"]').forEach(r => {
    r.addEventListener("change", () => setIntent(r.value));
  });

  // Confirm: revalidar y luego enviar
  btnConfirm.addEventListener("click", async (e) => {
    e.preventDefault();

    if (!isFormValid()){
      setMsg("<span class='err'>Revis√°: selecci√≥n, cantidad, hold activo, participantes, facturaci√≥n y comprobante.</span>");
      return;
    }

    btnConfirm.disabled = true;
    setSendMsg("<span class='muted'>Revalidando cupos‚Ä¶</span>");

    // 1) Confirmar hold (commit en backend)
    const commit = await apiPost(CONFIRM_ENDPOINT, {
      disponibilidad_id: STATE.disponibilidad_id,
      hold_id: STATE.hold.hold_id,
      client_id: ensureClientId()
    });

    if (!commit.ok || !commit.json || commit.json.ok !== true){
      setSendMsg("<span class='err'>No se pudo confirmar: cupos cambiaron o el hold expir√≥. Volv√© a intentar.</span>");
      // limpiar hold local si expir√≥
      if (commit.status === 410) {
        STATE.hold = null;
        hideHoldBar();
        applyUIAccess();
      }
      btnConfirm.disabled = !isFormValid();
      return;
    }

    // 2) Enviar a Zoho Flow (tu proceso actual)
    setSendMsg("<span class='muted'>Enviando datos‚Ä¶</span>");
    const payload = buildPayload();

    try{
      const res = await apiPost(RESERVA_ENDPOINT, payload);
      if (res.ok && res.json && res.json.ok === true){
        setSendMsg(`<span class='ok'>Enviado correctamente. Una vez confirmado el pago se te notificar√° por correo.</span>`);
        // liberar estado local (ya est√° confirmado en backend)
        STATE.hold = null;
        hideHoldBar();
        if (STATE.hold_timer) { clearInterval(STATE.hold_timer); STATE.hold_timer = null; }
        applyUIAccess();
      } else {
        setSendMsg(`<span class='err'>No se pudo completar el env√≠o. Contact√° con Todo Costura SA.</span>`);
      }

      debugEl.style.display = "none";
      debugEl.textContent =
        `POST ${res.status}\n` +
        `URL: ${RESERVA_ENDPOINT}\n\n` +
        `${res.text}\n\n` +
        `PAYLOAD:\n${JSON.stringify(payload, null, 2)}`;

    } catch (e2){
      setSendMsg(`<span class='err'>Error de red: ${htmlEscape(e2?.message || String(e2))}</span>`);
    } finally {
      btnConfirm.disabled = !isFormValid();
    }
  });

  // =====================
  // Bootstrap
  // =====================
  async function loadBootstrap(courseId){
    showLoading("Cargando informaci√≥n del curso‚Ä¶", "Recuperando datos desde el sistema.", 0.25);

    const res = await apiGet(`${API_BASE}/api/bootstrap?course_id=${encodeURIComponent(courseId)}`);

    if (!res.ok || !res.json){
      setStatus(`Error (HTTP ${res.status})`);
      showLoading("No se pudo cargar", "Verific√° el course_id y que existan datos en KV.", 0.25);
      return null;
    }

    if (res.json.ok !== true){
      setStatus("Sin datos");
      showLoading("Sin datos para este curso", "Ejecut√° ingest primero o verific√° el ID.", 0.25);
      return res.json;
    }

    showLoading("Preparando turnos‚Ä¶", "Aplicando validaciones y disponibilidad.", 0.60);

    STATE.course_id = courseId;
    STATE.course = res.json.course || null;
    STATE.slots = res.json.slots || res.json.horarios || [];

    // üëá disponibilidad_id debe venir del bootstrap
    STATE.disponibilidad_id = String(res.json.disponibilidad_id || "").trim() || null;

    // fallback: si todav√≠a no lo ten√©s en backend, no se puede tener inventario compartido real
    if (!STATE.disponibilidad_id){
      setStatus("Error ¬∑ falta disponibilidad");
      setMsg("<span class='err'>Este curso no trae disponibilidad_id en /api/bootstrap. Debe incluirse para inventario compartido.</span>");
      showLoading("Falta disponibilidad_id", "Ajust√° /api/bootstrap para devolver disponibilidad_id.", 0.25);
      return res.json;
    }

    // Inicialmente, usamos el cupo del primer slot como snapshot base (hasta que DO responda)
    const first = STATE.slots && STATE.slots[0] ? STATE.slots[0] : null;
    const snap = normalizeInt(first?.cupos_disponibles);
    STATE.available_rt = Number.isFinite(snap) ? snap : null;

    renderServiceInfo();
    renderSlots(STATE.slots);

    refreshBillingDocUI();
    applyUIAccess();

    // conectar WS para cupo RT real
    connectWS();

    setStatus(`Listo ¬∑ ${(STATE.slots||[]).length} turnos`);
    showLoading("Listo", "Pod√©s continuar.", 1.0);
    setTimeout(hideLoading, 180);

    return res.json;
  }

  // =====================
  // Init
  // =====================
  (async function init(){
    setupLogo();
    ensureClientId();

    const courseId = getCourseIdFromHash();
    if (!courseId){
      hideLoading();
      setStatus("Falta #ID=‚Ä¶");
      setMsg("<span class='err'>Abr√≠ esta p√°gina con un hash v√°lido, por ejemplo: <b>#ID=4537469...</b></span>");
      slotsEl.innerHTML = "";
      return;
    }

    setStatus("Cargando‚Ä¶");
    showLoading("Cargando informaci√≥n del curso‚Ä¶", "Conectando con el sistema.", 0.10);

    await loadBootstrap(courseId);
  })();
</script>
</body>
</html>
