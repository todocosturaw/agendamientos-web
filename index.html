<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Agenda de Cursos | Todo Costura</title>
  <meta name="description" content="Reservá tu curso. Seleccioná fecha y confirmá en segundos." />
  <meta name="theme-color" content="#ffffff" />

  <style>
    :root{
      --brand:#a52b64;
      --brand2:#c94b86;
      --bg:#f6f7fb;
      --card:#ffffff;
      --txt:#111827;
      --muted:#6b7280;
      --muted2:#9aa3b2;
      --line:#e5e7eb;
      --line2:#eef1f5;
      --shadow: 0 14px 34px rgba(17,24,39,.10);
      --shadow2: 0 26px 60px rgba(17,24,39,.12);
      --radius:18px;
      --radius2:24px;
      --max: 1220px;
      --pad: clamp(16px, 2.2vw, 26px);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--txt);
      font-family:var(--sans);
      background:
        radial-gradient(1000px 420px at 10% -10%, rgba(165,43,100,.10), transparent 60%),
        radial-gradient(900px 420px at 92% 0%, rgba(201,75,134,.10), transparent 58%),
        var(--bg);
      overflow-x:hidden;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }
    a{color:inherit; text-decoration:none}
    button, input, select, textarea{font:inherit}
    .wrap{max-width:var(--max); margin:0 auto; padding:0 var(--pad)}
    .hidden{display:none !important}

    header{
      position:sticky; top:0; z-index:50;
      background: rgba(255,255,255,.82);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--line2);
    }
    .nav{
      display:flex; align-items:center; justify-content:space-between;
      padding: 14px 0;
      gap: 12px;
    }
    .brand{display:flex; align-items:center; gap:12px;}
    .logo{
      width:42px; height:42px; border-radius: 14px;
      background: linear-gradient(180deg, var(--brand), rgba(165,43,100,.78));
      box-shadow: 0 12px 24px rgba(165,43,100,.18);
      position:relative;
      overflow:hidden;
    }
    .logo:after{
      content:"";
      position:absolute; inset:-60px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.45), transparent 55%);
      transform: rotate(15deg);
      opacity:.55;
    }
    .brand .name{display:flex; flex-direction:column; line-height:1.05;}
    .brand .name b{font-size: 14px; letter-spacing:.6px; text-transform: uppercase;}
    .brand .name span{font-size: 12.5px; color:var(--muted);}
    .navcta{display:flex; align-items:center; gap: 10px;}
    .btn{
      cursor:pointer;
      border:1px solid var(--line);
      background: #fff;
      color:var(--txt);
      padding: 10px 14px;
      border-radius: 999px;
      transition: .18s ease;
      user-select:none;
      box-shadow: 0 10px 22px rgba(17,24,39,.06);
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(165,43,100,.25);}
    .btn.primary{
      border:0;
      background: linear-gradient(180deg, var(--brand), rgba(165,43,100,.82));
      color:#fff;
      box-shadow: 0 16px 30px rgba(165,43,100,.18);
    }
    .btn.primary:hover{ filter: saturate(1.04); }
    .btn.wide{ width:100%; border-radius: 14px; font-weight: 800; }

    .hero{ padding: 38px 0 24px; }
    .heroGrid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap: clamp(16px, 2.6vw, 28px);
      align-items:stretch;
    }
    @media (max-width: 980px){ .heroGrid{grid-template-columns:1fr} }

    h1{
      margin: 0 0 10px;
      font-size: clamp(30px, 3.8vw, 54px);
      line-height: 1.06;
      letter-spacing: -0.02em;
    }
    .gradText{
      background: linear-gradient(90deg, var(--txt), rgba(165,43,100,.92) 55%, rgba(201,75,134,.88));
      -webkit-background-clip:text;
      background-clip:text;
      color: transparent;
    }
    .lead{
      font-size: clamp(14.5px, 1.2vw, 17px);
      color: var(--muted);
      line-height: 1.65;
      margin: 0 0 18px;
      max-width: 70ch;
    }

    .card{
      border-radius: var(--radius2);
      background: rgba(255,255,255,.92);
      border: 1px solid var(--line);
      box-shadow: var(--shadow2);
      position:relative;
      overflow:hidden;
    }
    .card:before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(820px 240px at 10% 0%, rgba(165,43,100,.10), transparent 60%);
      pointer-events:none;
    }
    .cardInner{ position:relative; padding: 18px; }

    .cardTop{display:flex; align-items:flex-start; justify-content:space-between; gap: 12px; margin-bottom: 10px;}
    .badge{
      display:inline-flex; align-items:center; gap:10px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(165,43,100,.22);
      background: rgba(165,43,100,.08);
      font-size: 12px;
      font-weight: 700;
      white-space:nowrap;
    }
    .badge i{
      width: 10px; height:10px; border-radius: 99px;
      background: var(--brand);
      box-shadow: 0 0 0 6px rgba(165,43,100,.12);
      display:inline-block;
    }
    .cardTitle{
      margin: 0;
      font-size: 13px;
      letter-spacing:.6px;
      text-transform: uppercase;
      color: rgba(17,24,39,.92);
      font-weight: 900;
    }
    .cardHint{
      margin: 6px 0 0;
      font-size: 13px;
      color: var(--muted);
      line-height:1.45;
    }
    .divider{height:1px; background: var(--line2); margin: 14px 0;}

    .field{display:flex; flex-direction:column; gap: 8px;}
    .labelRow{display:flex; align-items:center; justify-content:space-between; gap: 10px;}
    .labelRow label{
      font-size: 12px;
      letter-spacing:.5px;
      text-transform: uppercase;
      color: rgba(17,24,39,.82);
      font-weight: 800;
    }
    .pill{
      font-size: 11px;
      color: rgba(17,24,39,.78);
      border: 1px solid var(--line);
      background: rgba(255,255,255,.92);
      border-radius: 999px;
      padding: 6px 10px;
    }
    .control{
      border-radius: 14px;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--txt);
      padding: 12px 12px;
      outline:none;
      transition: .18s ease;
    }
    .control:focus{
      border-color: rgba(165,43,100,.45);
      box-shadow: 0 0 0 6px rgba(165,43,100,.12);
    }
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap: 12px;}
    @media (max-width: 560px){ .grid2{grid-template-columns:1fr} }

    .slots{display:flex; flex-wrap:wrap; gap: 8px; margin-top: 6px;}
    .slot{
      border: 1px solid var(--line);
      background: #fff;
      color: rgba(17,24,39,.92);
      border-radius: 999px;
      padding: 10px 12px;
      font-size: 12.5px;
      cursor:pointer;
      transition:.18s ease;
      user-select:none;
    }
    .slot:hover{
      transform: translateY(-1px);
      border-color: rgba(165,43,100,.25);
      background: rgba(165,43,100,.04);
    }
    .slot.active{
      border-color: rgba(165,43,100,.55);
      box-shadow: 0 0 0 6px rgba(165,43,100,.10);
      background: rgba(165,43,100,.10);
    }
    .slot.disabled{
      opacity:.45;
      cursor:not-allowed;
      text-decoration: line-through;
      background: #fafafa;
    }

    .summary{
      margin-top: 14px;
      padding: 14px;
      border-radius: 16px;
      background: rgba(245,246,250,.95);
      border: 1px solid var(--line);
    }
    .sumRow{
      display:flex; align-items:center; justify-content:space-between;
      gap: 12px;
      margin: 8px 0;
      font-size: 13px;
      color: rgba(17,24,39,.92);
    }
    .sumRow span{color: var(--muted)}
    .total{
      margin-top: 10px;
      padding-top: 12px;
      border-top: 1px dashed rgba(165,43,100,.28);
      display:flex; align-items:center; justify-content:space-between;
    }
    .total b{font-size: 15px; letter-spacing:.2px;}
    .total .amt{
      font-family: var(--mono);
      font-size: 15px;
      background: #fff;
      border: 1px solid rgba(165,43,100,.25);
      border-radius: 999px;
      padding: 10px 12px;
      color: rgba(17,24,39,.92);
    }

    .toast{
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 100;
      width: min(420px, calc(100% - 36px));
      border-radius: 18px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.95);
      box-shadow: var(--shadow2);
      overflow:hidden;
      transform: translateY(18px);
      opacity: 0;
      pointer-events:none;
      transition: .22s ease;
    }
    .toast.show{ transform: translateY(0); opacity: 1; pointer-events:auto; }
    .toastBar{ height: 4px; background: linear-gradient(90deg, var(--brand), var(--brand2)); }
    .toastBody{ padding: 14px; display:flex; gap: 12px; align-items:flex-start; }
    .toastBody b{ display:block; font-size: 13px; margin-bottom: 4px; }
    .toastBody p{ margin:0; font-size: 12.5px; color: var(--muted); line-height: 1.45; }
    .toastClose{
      margin-left:auto;
      width: 36px; height:36px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: #fff;
      cursor:pointer;
      transition:.18s ease;
      display:grid; place-items:center;
    }
    .toastClose:hover{ background: rgba(165,43,100,.06); transform: translateY(-1px) }
  </style>
</head>

<body>
  <header>
    <div class="wrap nav">
      <a class="brand" href="#inicio" aria-label="Inicio">
        <div class="logo" aria-hidden="true"></div>
        <div class="name">
          <b>Todo Costura</b>
          <span>Agendamientos de Cursos</span>
        </div>
      </a>

      <div class="navcta">
        <a class="btn primary" href="#reservar">Reservar</a>
      </div>
    </div>
  </header>

  <main id="inicio">
    <div class="wrap hero">
      <div class="heroGrid">
        <div>
          <h1>
            Reservá tu curso con un flujo
            <span class="gradText">simple y profesional</span>.
          </h1>
          <p class="lead" id="heroLead">
            Cargando información del curso…
          </p>
        </div>

        <div class="card" id="reservar">
          <div class="cardInner">
            <div class="cardTop">
              <div>
                <p class="cardTitle">Reserva de Curso</p>
                <p class="cardHint" id="cardHint">Validación real en backend (Worker).</p>
              </div>
              <div class="badge"><i></i> Confirmación</div>
            </div>

            <div class="divider"></div>

            <div class="field">
              <div class="labelRow">
                <label>Curso</label>
                <span class="pill" id="pillCourse">—</span>
              </div>
              <div class="control" id="courseBox" style="padding:12px; border-radius:14px; line-height:1.55;">
                <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                  <b id="courseName">—</b>
                  <span class="pill" id="coursePrice">—</span>
                </div>
                <div style="margin-top:8px; color:var(--muted); font-size:12.5px;" id="courseMeta">—</div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="field">
              <div class="labelRow">
                <label>Fechas disponibles</label>
                <span class="pill" id="pillDate">Seleccionar</span>
              </div>
              <div class="slots" id="slots" aria-label="Fechas"></div>
              <div style="margin-top:8px; color:var(--muted); font-size:12.5px; line-height:1.5;">
                Solo se permiten fechas definidas por el curso (Zoho Creator). Las fechas fuera de ventana aparecen deshabilitadas.
              </div>
            </div>

            <div class="divider"></div>

            <div class="grid2">
              <div class="field">
                <div class="labelRow">
                  <label>Asistentes</label>
                  <span class="pill" id="pillSeats">1</span>
                </div>
                <select class="control" id="seats">
                  <option value="1">1 asistente</option>
                  <option value="2">2 asistentes</option>
                  <option value="3">3 asistentes</option>
                  <option value="4">4 asistentes</option>
                  <option value="5">5 asistentes</option>
                </select>
              </div>

              <div class="field">
                <div class="labelRow">
                  <label>Documento</label>
                  <span class="pill">Opcional</span>
                </div>
                <select class="control" id="documento">
                  <option value="">—</option>
                  <option value="RUC">RUC</option>
                  <option value="CI">CI</option>
                </select>
              </div>
            </div>

            <div class="grid2" style="margin-top:12px">
              <div class="field">
                <div class="labelRow">
                  <label>N° documento</label>
                  <span class="pill">Opcional</span>
                </div>
                <input class="control" id="nroDoc" placeholder="Ej: 6247029" />
              </div>
              <div class="field">
                <div class="labelRow">
                  <label>Razón social</label>
                  <span class="pill">Obligatorio</span>
                </div>
                <input class="control" id="razon" placeholder="Nombre y apellido / Empresa" />
              </div>
            </div>

            <div class="grid2" style="margin-top:12px">
              <div class="field">
                <div class="labelRow">
                  <label>Email</label>
                  <span class="pill">Opcional</span>
                </div>
                <input class="control" id="email" placeholder="correo@dominio.com" inputmode="email" autocomplete="email" />
              </div>
              <div class="field">
                <div class="labelRow">
                  <label>WhatsApp</label>
                  <span class="pill">Opcional</span>
                </div>
                <input class="control" id="whatsapp" placeholder="+595 9xx xxx xxx" inputmode="tel" autocomplete="tel" />
              </div>
            </div>

            <div class="summary" aria-label="Resumen">
              <div class="sumRow"><span>Curso</span><b id="sumCourse">—</b></div>
              <div class="sumRow"><span>Fecha</span><b id="sumDate">—</b></div>
              <div class="sumRow"><span>Asistentes</span><b id="sumSeats">1</b></div>
              <div class="total">
                <b>Total</b>
                <div class="amt" id="sumTotal">Gs. 0</div>
              </div>
            </div>

            <div style="margin-top:14px">
              <button class="btn primary wide" id="btnReserve">Confirmar reserva</button>
            </div>

            <div style="margin-top:10px; font-size:12.5px; color:var(--muted); line-height:1.5;">
              Producción: la UI consume <code>/api/bootstrap</code>, valida con <code>/api/availability</code> y crea con <code>/reserve</code>.
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div class="toast" id="toast" role="status" aria-live="polite" aria-atomic="true">
    <div class="toastBar" aria-hidden="true"></div>
    <div class="toastBody">
      <div style="width:40px;height:40px;border-radius:14px;background:rgba(165,43,100,.08);border:1px solid rgba(165,43,100,.18);display:grid;place-items:center;flex:0 0 auto" aria-hidden="true">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
          <path d="M12 2l9 4v6c0 5-3.5 9.4-9 10-5.5-.6-9-5-9-10V6l9-4Z" stroke="rgba(17,24,39,.78)" stroke-width="1.6" stroke-linejoin="round"/>
          <path d="M8.8 12l2.2 2.2L15.6 9.6" stroke="rgba(17,24,39,.78)" stroke-width="1.6" stroke-linecap="round"/>
        </svg>
      </div>
      <div>
        <b id="toastTitle">Listo</b>
        <p id="toastMsg">Acción completada.</p>
      </div>
      <button class="toastClose" id="toastClose" aria-label="Cerrar">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
          <path d="M7 7l10 10M17 7L7 17" stroke="rgba(17,24,39,.75)" stroke-width="1.6" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
  </div>

  <script>
    // =========================
    // Configuración
    // =========================
    const API_BASE = "https://api.taller2.workers.dev";
    const $ = (id) => document.getElementById(id);

    const CURRENCY = "PYG";
    const fmt = (n) =>
      new Intl.NumberFormat("es-PY", { style: "currency", currency: CURRENCY, maximumFractionDigits: 0 })
        .format(n || 0);

    // Estado UI
    const state = {
      courseId: null,       // ID del curso (Todos_los_cursos.ID)
      course: null,
      slots: [],
      selectedSlotId: null, // Datos_horarios[].ID
      selectedDateIso: null,
      seats: 1,
    };

    function toast(title, msg) {
      $("toastTitle").textContent = title;
      $("toastMsg").textContent = msg;
      const t = $("toast");
      t.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(() => t.classList.remove("show"), 4200);
    }

    function getHashParam(name) {
      // Ej: #reservar?ID=453...
      const h = (location.hash || "").replace(/^#/, "");
      const qIndex = h.indexOf("?");
      if (qIndex < 0) return "";
      const qs = h.slice(qIndex + 1);
      const sp = new URLSearchParams(qs);
      return sp.get(name) || "";
    }

    function setCourseUI(course) {
      $("pillCourse").textContent = course?.name || "—";
      $("courseName").textContent = course?.name || "—";
      $("coursePrice").textContent = fmt(course?.price || 0);

      const bits = [];
      if (course?.category) bits.push(course.category);
      if (course?.platform) bits.push(course.platform);
      if (course?.type) bits.push(course.type);
      if (course?.tutor) bits.push(("Tutor: " + course.tutor).replace(/\s+/g, " ").trim());
      $("courseMeta").textContent = bits.length ? bits.join(" · ") : "—";

      $("heroLead").textContent = "Curso cargado. Seleccioná una fecha disponible para reservar.";
    }

    function renderSlots() {
      const host = $("slots");
      host.innerHTML = "";

      const list = Array.isArray(state.slots) ? state.slots : [];
      if (!list.length) {
        host.innerHTML = `<div style="color:var(--muted); font-size:12.5px;">No hay fechas disponibles.</div>`;
        return;
      }

      for (const s of list) {
        const el = document.createElement("div");
        const disabled = !s.enabled;
        const active = state.selectedSlotId === s.slot_id;

        el.className = "slot" + (disabled ? " disabled" : "") + (active ? " active" : "");
        el.textContent = s.date_display || s.date_iso;

        if (!disabled) {
          el.addEventListener("click", async () => {
            state.selectedSlotId = s.slot_id;
            state.selectedDateIso = s.date_iso;
            $("pillDate").textContent = s.date_display || s.date_iso;
            updateSummary();
            renderSlots();
            await checkAvailability();
          });
        }

        host.appendChild(el);
      }
    }

    function updateSummary() {
      $("sumCourse").textContent = state.course?.name || "—";
      $("sumDate").textContent = state.selectedDateIso || "—";
      $("sumSeats").textContent = String(state.seats || 1);
      $("pillSeats").textContent = String(state.seats || 1);

      const price = Number(state.course?.price || 0);
      $("sumTotal").textContent = fmt(price * (state.seats || 1));
    }

    // =========================
    // API calls (CORREGIDO)
    // =========================
    async function loadBootstrap(courseId) {
      const u = new URL(API_BASE + "/api/bootstrap");
      u.searchParams.set("course_id", courseId);

      const r = await fetch(u.toString(), { method: "GET" });
      const data = await r.json().catch(() => null);

      if (!r.ok || !data?.ok) {
        const msg = data?.error ? String(data.error) : ("bootstrap http " + r.status);
        throw new Error(msg);
      }

      return data; // { ok:true, course_id, course, slots, selected_slot }
    }

    async function checkAvailability() {
      // Tu backend actual puede no tener availability real por slots del curso.
      // Mantenemos la llamada si existe, pero no bloqueamos si el endpoint no está alineado.
      if (!state.selectedSlotId) return true;

      try {
        const u = new URL(API_BASE + "/api/availability");
        u.searchParams.set("slot_id", state.selectedSlotId);
        u.searchParams.set("seats", String(state.seats || 1));

        const r = await fetch(u.toString(), { method: "GET" });
        if (!r.ok) return true; // no bloquear UI si no está alineado
        const data = await r.json().catch(() => null);
        if (!data?.ok) return true;

        if (data.can_book !== true) {
          toast("No disponible", (data.reasons && data.reasons[0]) ? data.reasons[0] : "No se puede reservar este slot.");
          return false;
        }
        return true;
      } catch {
        return true;
      }
    }

    function validate() {
      const errs = [];
      if (!state.selectedSlotId) errs.push("Seleccioná una fecha.");
      if (!$("razon").value.trim()) errs.push("Razón social es obligatoria.");
      const email = $("email").value.trim();
      if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) errs.push("El email no parece válido.");
      return errs;
    }

    async function postReserve() {
      const errs = validate();
      if (errs.length) {
        toast("Revisión requerida", errs[0]);
        return;
      }

      const okAv = await checkAvailability();
      if (!okAv) return;

      // Estructura recomendada: course_id + booking + student + billing (simple)
      const body = {
        course_id: state.courseId,
        booking: {
          slot_id: state.selectedSlotId,
          date: state.selectedDateIso,
          time: null,
          seats: Number($("seats").value || 1),
        },
        student: {
          name: $("razon").value.trim(),
          email: $("email").value.trim(),
          phone: $("whatsapp").value.trim(),
        },
        billing: {
          document_type: $("documento").value,
          document_number: $("nroDoc").value.trim(),
          razon_social: $("razon").value.trim(),
        },
        meta: {
          platform: state.course?.platform || "Presencial",
          status: "No pagado",
          source: "web",
        }
      };

      try {
        const r = await fetch(API_BASE + "/reserve", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });

        const data = await r.json().catch(() => null);
        if (!r.ok || !data?.ok) {
          toast("Error", data?.error || "No se pudo crear la reserva.");
          console.error("reserve error:", r.status, data);
          return;
        }

        toast("Reserva enviada", "La solicitud fue registrada.");
        console.log("reserve ok:", data);
      } catch (e) {
        console.error(e);
        toast("Conexión fallida", "No se pudo contactar al Worker.");
      }
    }

    (async function init() {
      $("toastClose").addEventListener("click", () => $("toast").classList.remove("show"));

      $("seats").addEventListener("change", async () => {
        state.seats = Number($("seats").value || 1);
        updateSummary();
        await checkAvailability();
      });

      $("btnReserve").addEventListener("click", postReserve);

      // IMPORTANTE: ID en la URL ahora es COURSE_ID (no slot_id)
      const courseId = getHashParam("ID").trim();
      if (!courseId) {
        toast("Falta ID", "Abrí la página con #reservar?ID=...");
        $("heroLead").textContent = "Falta el parámetro ID (course_id) en la URL.";
        return;
      }

      state.courseId = courseId;

      try {
        const boot = await loadBootstrap(courseId);

        state.course = boot.course;
        state.slots = boot.slots || [];

        // Selección inicial: primer slot habilitado (o primero)
        const firstEnabled = (state.slots || []).find(s => s.enabled) || (state.slots || [])[0] || null;
        state.selectedSlotId = firstEnabled?.slot_id || null;
        state.selectedDateIso = firstEnabled?.date_iso || null;

        setCourseUI(state.course);

        $("pillDate").textContent = firstEnabled?.date_display || firstEnabled?.date_iso || "Seleccionar";

        updateSummary();
        renderSlots();

        await checkAvailability();
        toast("Interfaz lista", "Seleccioná los datos y confirmá la reserva.");
      } catch (e) {
        console.error(e);
        toast("Error", "No se pudo cargar el curso desde Zoho/Worker.");
        $("heroLead").textContent = "No se pudo cargar la información del curso.";
      }
    })();
  </script>
</body>
</html>
