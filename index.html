<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Agenda de Cursos | Todo Costura</title>
  <meta name="description" content="Reservá tu curso. Seleccioná fecha, horario y confirmá en segundos.">
  <meta name="theme-color" content="#ffffff">
  <style>
    :root{
      --brand:#a52b64;
      --brand2:#c94b86;
      --bg:#f6f7fb;
      --card:#ffffff;
      --txt:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --shadow:0 10px 30px rgba(17,24,39,.08);
      --r:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:var(--bg);
      color:var(--txt);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:28px 18px}
    .top{
      display:flex;align-items:flex-start;justify-content:space-between;gap:14px;flex-wrap:wrap;
      margin-bottom:14px;
    }
    h1{margin:0;font-size:22px;letter-spacing:.2px}
    .sub{margin:6px 0 0 0;color:var(--muted);font-size:14px}
    .badge{
      padding:6px 10px;border-radius:999px;background:#fff;border:1px solid var(--line);
      color:var(--muted);font-size:12px
    }
    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
    }
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:16px;
    }
    .card h2{margin:0 0 10px 0;font-size:16px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .field{flex:1 1 220px}
    label{display:block;margin:8px 0 6px 0;font-size:13px;color:var(--muted)}
    input[type="text"], input[type="email"], input[type="number"], select, textarea{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      outline:none;
      background:#fff;
      color:var(--txt);
      font-size:14px;
    }
    textarea{min-height:84px;resize:vertical}
    input:focus, select:focus, textarea:focus{
      border-color:rgba(165,43,100,.55);
      box-shadow:0 0 0 4px rgba(165,43,100,.12);
    }
    .slot{
      display:flex;gap:10px;align-items:flex-start;
      padding:10px 10px;border:1px solid var(--line);border-radius:12px;background:#fff;
      margin:8px 0;
    }
    .slot label{margin:0;color:var(--txt)}
    .slot .meta{font-size:12px;color:var(--muted);margin-top:2px}
    .pill{
      display:inline-block;padding:4px 8px;border-radius:999px;
      border:1px solid var(--line);color:var(--muted);font-size:12px;background:#fff;
    }
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{
      border:0;border-radius:12px;cursor:pointer;
      padding:11px 14px;font-weight:700;font-size:14px;
    }
    .primary{
      background:linear-gradient(135deg,var(--brand),var(--brand2));
      color:#fff;
    }
    .ghost{
      background:#fff;border:1px solid var(--line);color:var(--txt);
      font-weight:600;
    }
    button:disabled{opacity:.55;cursor:not-allowed}
    .err{color:#b00020;font-weight:650}
    .ok{color:#0a7a2f;font-weight:650}
    .pbox{border:1px solid var(--line);border-radius:12px;padding:12px;margin-top:10px;background:#fff}
    pre{
      margin:12px 0 0 0;
      background:#fff;
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px;
      white-space:pre-wrap;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
      font-size:12px;
      color:#111827;
    }
    .tiny{font-size:12px}
    .divider{height:1px;background:var(--line);margin:12px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Agenda de Cursos</h1>
        <p class="sub">Seleccioná un horario disponible y completá los datos para confirmar tu reserva.</p>
      </div>
      <div class="badge" id="status">Inicializando…</div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Curso</h2>
        <div id="courseBox" class="muted">Cargando…</div>

        <div class="divider"></div>

        <h2>Horarios</h2>
        <div id="slots"></div>
        <div id="slotsHelp" class="muted tiny"></div>
      </div>

      <div class="card">
        <h2>Reserva</h2>

        <div class="row">
          <div class="field">
            <label for="qty">Cantidad de personas</label>
            <input id="qty" type="number" min="1" step="1" value="1" disabled>
            <div id="qtyHint" class="muted tiny"></div>
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="btnBuild" class="ghost" disabled>Generar participantes</button>
          </div>
        </div>

        <div id="namesWrap"></div>

        <div class="divider"></div>

        <h2>Facturación</h2>
        <div class="row">
          <div class="field">
            <label for="billName">Razón social / Nombre *</label>
            <input id="billName" type="text" placeholder="Ej: Juan Pérez / Todo Costura S.A.">
          </div>
          <div class="field">
            <label for="billDocType">Tipo de documento *</label>
            <select id="billDocType">
              <option value="personal" selected>Documento personal (Cédula)</option>
              <option value="fiscal">Documento fiscal (RUC)</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label id="billDocLabel" for="billDocNumber">Documento personal (Cédula) *</label>
            <input id="billDocNumber" type="text" placeholder="Ej: 1234567">
          </div>
          <div class="field">
            <label for="billEmail">Correo de facturación *</label>
            <input id="billEmail" type="email" placeholder="facturacion@dominio.com">
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label for="billPhone">Teléfono (opcional)</label>
            <input id="billPhone" type="text" placeholder="+595...">
          </div>
          <div class="field">
            <label for="billAddress">Dirección *</label>
            <input id="billAddress" type="text" placeholder="Calle, número, barrio">
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label for="billCity">Ciudad *</label>
            <input id="billCity" type="text" placeholder="Ej: Asunción">
          </div>
        </div>

        <div class="divider"></div>

        <h2>Comprobante de pago</h2>
        <div class="row">
          <div class="field">
            <label for="payFile">Adjuntar comprobante (JPG/PNG/PDF) *</label>
            <input id="payFile" type="file" accept="image/*,application/pdf">
            <div class="muted tiny">Máximo 5 MB.</div>
          </div>
          <div class="field">
            <label>Estado</label>
            <div id="payFileStatus" class="muted tiny">Sin archivo</div>
          </div>
        </div>

        <div class="divider"></div>

        <h2>Confirmación</h2>
        <div class="btns">
          <button id="btnPreview" class="ghost" disabled>Vista previa</button>
          <button id="btnConfirm" class="primary" disabled>Confirmar y enviar</button>
        </div>
        <div id="formMsg" style="margin-top:10px"></div>
        <div id="sendMsg" style="margin-top:10px"></div>
        <pre id="previewJson" style="display:none;"></pre>

        <pre id="debug" style="display:none;"></pre>
      </div>
    </div>
  </div>

<script>
  // =====================
  // Config
  // =====================
  const API_BASE = "https://api.taller2.workers.dev";
  const RESERVA_ENDPOINT = `${API_BASE}/api/reserva`;

  const POLL_DELAY_MS = 1500;
  const POLL_MAX_TRIES = 120;

  const MAX_FILE_BYTES = 5 * 1024 * 1024; // 5MB

  // =====================
  // DOM
  // =====================
  const statusEl = document.getElementById("status");
  const slotsEl = document.getElementById("slots");
  const slotsHelpEl = document.getElementById("slotsHelp");
  const debugEl = document.getElementById("debug");
  const courseBoxEl = document.getElementById("courseBox");

  const qtyEl = document.getElementById("qty");
  const qtyHintEl = document.getElementById("qtyHint");
  const btnBuild = document.getElementById("btnBuild");
  const namesWrap = document.getElementById("namesWrap");

  const formMsg = document.getElementById("formMsg");
  const sendMsg = document.getElementById("sendMsg");
  const previewJsonEl = document.getElementById("previewJson");

  // Billing
  const billNameEl = document.getElementById("billName");
  const billDocTypeEl = document.getElementById("billDocType");
  const billDocLabelEl = document.getElementById("billDocLabel");
  const billDocNumberEl = document.getElementById("billDocNumber");
  const billEmailEl = document.getElementById("billEmail");
  const billPhoneEl = document.getElementById("billPhone");
  const billAddressEl = document.getElementById("billAddress");
  const billCityEl = document.getElementById("billCity");

  // Payment proof
  const payFileEl = document.getElementById("payFile");
  const payFileStatusEl = document.getElementById("payFileStatus");

  // Confirm
  const btnPreview = document.getElementById("btnPreview");
  const btnConfirm = document.getElementById("btnConfirm");

  // =====================
  // State
  // =====================
  let STATE = {
    course_id: null,
    course: null,
    slots: [],
    selected_slot: null,
    last_preview_payload: null,
    payment_proof: null // {filename,mime_type,size_bytes,base64}
  };

  // =====================
  // Helpers
  // =====================
  function setStatus(t){ statusEl.textContent = t; }
  function setMsg(html, cls){ formMsg.className = cls || ""; formMsg.innerHTML = html || ""; }
  function setSendMsg(html, cls){ sendMsg.className = cls || ""; sendMsg.innerHTML = html || ""; }

  function getCourseIdFromHash(){
    const h = (location.hash || "").replace(/^#/, "");
    const p = new URLSearchParams(h);
    return p.get("ID") || p.get("course_id");
  }

  async function apiGet(url){
    const r = await fetch(url, { method:"GET" });
    const t = await r.text();
    let j=null; try{ j=JSON.parse(t);}catch{}
    return {ok:r.ok, status:r.status, text:t, json:j, url};
  }

  async function apiPost(url, body){
    const r = await fetch(url, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body||{})
    });
    const t = await r.text();
    let j=null; try{ j=JSON.parse(t);}catch{}
    return {ok:r.ok, status:r.status, text:t, json:j, url};
  }

  async function postReserva(payload){
    const r = await fetch(RESERVA_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    const t = await r.text();
    let j=null; try{ j=JSON.parse(t);}catch{}
    return {ok:r.ok, status:r.status, text:t, json:j};
  }

  function normalizeInt(x){
    const n = Number(x);
    return Number.isFinite(n) ? Math.trunc(n) : NaN;
  }

  function isEmailBasic(v){
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(v||"").trim());
  }

  function htmlEscape(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function safeCourse(course){
    if (!course || typeof course !== "object") return null;
    return JSON.parse(JSON.stringify(course));
  }

  function resetPreview(){
    STATE.last_preview_payload = null;
    previewJsonEl.style.display = "none";
    previewJsonEl.textContent = "";
    btnConfirm.disabled = true;
  }

  // =====================
  // Render Curso
  // =====================
  function renderCourse(course){
    if (!course){
      courseBoxEl.innerHTML = "<em>Sin datos de curso</em>";
      return;
    }

    // Ajusta a tu estructura de bootstrap (si tu course viene con nombre_curso, etc.)
    const name = htmlEscape(course.name || course.nombre_curso || "Curso");
    const category = htmlEscape(course.category || course.categoria || "");
    const price = course.price ?? course.precio ?? null;
    const type = htmlEscape(course.type || "");
    const platform = htmlEscape(course.platform || course.plataforma || "");
    const learning = htmlEscape(course.learning_type || course.tipo_aprendizaje || "");
    const audience = htmlEscape(course.audience || course.alumnado || "");
    const mode = htmlEscape(course.participants_mode || course.participantes || "");
    const tutor = htmlEscape(course.tutor || "");

    courseBoxEl.innerHTML =
      `<div><strong>${name}</strong></div>` +
      `<div class="muted tiny">Categoría: ${category || "-"} · Tipo: ${type || "-"} · Precio: ${price ?? "-"}</div>` +
      `<div class="muted tiny">Plataforma: ${platform || "-"} · Modalidad: ${learning || "-"} · Audiencia: ${audience || "-"}</div>` +
      `<div class="muted tiny">Participantes: ${mode || "-"} ${tutor ? "· Tutor: "+tutor : ""}</div>`;
  }

  // =====================
  // Slots
  // =====================
  function disableForm(reason){
    qtyEl.disabled = true;
    btnBuild.disabled = true;
    btnPreview.disabled = true;
    btnConfirm.disabled = true;
    qtyHintEl.textContent = reason || "";
    namesWrap.innerHTML = "";
    setMsg(reason ? `<span class="muted">${htmlEscape(reason)}</span>` : "", "");
    setSendMsg("", "");
    resetPreview();
  }

  function renderSlots(slots){
    slotsEl.innerHTML = "";
    slotsHelpEl.textContent = "";
    STATE.selected_slot = null;

    if (!Array.isArray(slots) || slots.length === 0){
      slotsEl.innerHTML = "<em class='muted'>Sin horarios</em>";
      return disableForm("No hay horarios disponibles.");
    }

    slots.forEach((s, idx) => {
      const id = `slot_${idx}`;

      const box = document.createElement("div");
      box.className = "slot";

      const input = document.createElement("input");
      input.type = "radio";
      input.name = "slot";
      input.id = id;
      input.value = s.slot_id;

      input.addEventListener("change", () => {
        STATE.selected_slot = s;
        onSlotSelected();
      });

      const right = document.createElement("div");

      const lab = document.createElement("label");
      lab.htmlFor = id;
      lab.textContent = `${s.fecha} ${s.hora}`;
      right.appendChild(lab);

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.innerHTML =
        `Disponibles: <strong>${htmlEscape(s.cupos_disponibles)}</strong> · ` +
        `<span class="pill">slot: ${htmlEscape(s.slot_id)}</span>`;
      right.appendChild(meta);

      box.appendChild(input);
      box.appendChild(right);
      slotsEl.appendChild(box);
    });

    slotsHelpEl.textContent = "Seleccioná un horario para habilitar la cantidad de personas.";
    disableForm("Seleccioná un horario.");
  }

  function onSlotSelected(){
    const s = STATE.selected_slot;
    if (!s) return disableForm("Seleccioná un horario.");

    const disp = normalizeInt(s.cupos_disponibles);
    if (!Number.isFinite(disp) || disp <= 0) return disableForm("Este horario no tiene cupos disponibles.");

    qtyEl.disabled = false;
    qtyEl.min = "1";
    qtyEl.max = String(disp);

    let v = normalizeInt(qtyEl.value);
    if (!Number.isFinite(v) || v < 1) v = 1;
    if (v > disp) v = disp;
    qtyEl.value = String(v);

    qtyHintEl.textContent = `Máximo permitido por disponibilidad: ${disp}.`;
    btnBuild.disabled = false;

    const existingBlocks = namesWrap.querySelectorAll('[data-pblock="1"]').length;
    const qty = normalizeInt(qtyEl.value);
    if (existingBlocks && existingBlocks !== qty) buildParticipants();

    btnPreview.disabled = !isFormValid();
    setMsg("", "");
    setSendMsg("", "");
    resetPreview();
  }

  // =====================
  // Participants
  // =====================
  function makeField(i, key, labelText, type, required, placeholder){
    const wrap = document.createElement("div");
    wrap.className = "field";

    const lab = document.createElement("label");
    lab.htmlFor = `p${i}_${key}`;
    lab.textContent = labelText + (required ? " *" : "");
    wrap.appendChild(lab);

    const inp = document.createElement("input");
    inp.type = type;
    inp.id = `p${i}_${key}`;
    inp.placeholder = placeholder || "";

    inp.addEventListener("input", () => {
      btnPreview.disabled = !isFormValid();
      setSendMsg("");
      resetPreview();
    });

    wrap.appendChild(inp);
    return wrap;
  }

  function buildParticipants(){
    namesWrap.innerHTML = "";

    const s = STATE.selected_slot;
    if (!s) return;

    const disp = normalizeInt(s.cupos_disponibles);
    const qty = normalizeInt(qtyEl.value);

    if (!Number.isFinite(qty) || qty < 1){
      setMsg("Cantidad inválida.", "err");
      btnPreview.disabled = true;
      resetPreview();
      return;
    }
    if (!Number.isFinite(disp) || disp < 1){
      setMsg("Disponibilidad inválida para este horario.", "err");
      btnPreview.disabled = true;
      resetPreview();
      return;
    }
    if (qty > disp){
      setMsg(`No podés registrar ${qty}. Cupos disponibles: ${disp}.`, "err");
      btnPreview.disabled = true;
      resetPreview();
      return;
    }

    const title = document.createElement("div");
    title.className = "muted tiny";
    title.style.marginTop = "10px";
    title.textContent = "Datos de participantes (obligatorios: nombres, apellidos, cédula, email; opcional: contacto)";
    namesWrap.appendChild(title);

    for (let i=1;i<=qty;i++){
      const box = document.createElement("div");
      box.className = "pbox";
      box.setAttribute("data-pblock","1");

      const h = document.createElement("div");
      h.className = "muted tiny";
      h.style.marginBottom = "8px";
      h.textContent = `Participante ${i}`;
      box.appendChild(h);

      const row = document.createElement("div");
      row.className = "row";

      row.appendChild(makeField(i, "nombres", "Nombres", "text", true, "Ej: Juan Carlos"));
      row.appendChild(makeField(i, "apellidos", "Apellidos", "text", true, "Ej: Gómez López"));
      row.appendChild(makeField(i, "cedula", "Cédula", "text", true, "Ej: 1234567"));
      row.appendChild(makeField(i, "email", "Correo electrónico", "email", true, "Ej: correo@dominio.com"));

      const contacto = makeField(i, "contacto", "Contacto (opcional)", "text", false, "Ej: +595...");
      row.appendChild(contacto);

      box.appendChild(row);
      namesWrap.appendChild(box);
    }

    btnPreview.disabled = !isFormValid();
    setMsg("", "");
    setSendMsg("", "");
    resetPreview();
  }

  function getParticipants(){
    const blocks = Array.from(namesWrap.querySelectorAll('[data-pblock="1"]'));
    const out = [];
    for (let idx=0; idx<blocks.length; idx++){
      const i = idx + 1;
      const q = (k) => (namesWrap.querySelector(`#p${i}_${k}`)?.value || "").trim();
      out.push({
        nombres: q("nombres"),
        apellidos: q("apellidos"),
        cedula: q("cedula"),
        email: q("email"),
        contacto: q("contacto") || ""
      });
    }
    return out;
  }

  // =====================
  // Billing
  // =====================
  function refreshBillingDocUI(){
    const type = billDocTypeEl.value;
    if (type === "fiscal"){
      billDocLabelEl.textContent = "Documento fiscal (RUC) *";
      billDocNumberEl.placeholder = "Ej: 80012345-6";
    } else {
      billDocLabelEl.textContent = "Documento personal (Cédula) *";
      billDocNumberEl.placeholder = "Ej: 1234567";
    }
    btnPreview.disabled = !isFormValid();
    resetPreview();
  }

  function getBilling(){
    return {
      razon_social: (billNameEl.value||"").trim(),
      tipo_documento: billDocTypeEl.value,
      documento: (billDocNumberEl.value||"").trim(),
      email: (billEmailEl.value||"").trim(),
      telefono: (billPhoneEl.value||"").trim(),
      direccion: (billAddressEl.value||"").trim(),
      ciudad: (billCityEl.value||"").trim()
    };
  }

  function isBillingValid(){
    const b = getBilling();
    if (!b.razon_social) return false;
    if (!b.tipo_documento) return false;
    if (!b.documento) return false;
    if (!b.email || !isEmailBasic(b.email)) return false;
    if (!b.direccion) return false;
    if (!b.ciudad) return false;
    return true;
  }

  // =====================
  // Payment proof (file)
  // =====================
  function isPaymentProofValid(){
    return Boolean(STATE.payment_proof && STATE.payment_proof.base64);
  }

  function fileToBase64(file){
    return new Promise((resolve, reject)=>{
      const reader = new FileReader();
      reader.onerror = () => reject(new Error("No se pudo leer el archivo"));
      reader.onload = () => {
        const result = String(reader.result || "");
        const idx = result.indexOf("base64,");
        if (idx === -1) return reject(new Error("Formato Base64 inválido"));
        const base64 = result.substring(idx + 7);
        resolve(base64);
      };
      reader.readAsDataURL(file);
    });
  }

  async function handlePaymentFile(file){
    STATE.payment_proof = null;
    payFileStatusEl.textContent = "Procesando…";
    resetPreview();

    if (!file){
      payFileStatusEl.textContent = "Sin archivo";
      btnPreview.disabled = !isFormValid();
      return;
    }

    if (file.size > MAX_FILE_BYTES){
      payFileStatusEl.textContent = "Archivo demasiado grande (máx 5 MB)";
      btnPreview.disabled = true;
      return;
    }

    try{
      const base64 = await fileToBase64(file);
      STATE.payment_proof = {
        filename: file.name,
        mime_type: file.type || "application/octet-stream",
        size_bytes: file.size,
        base64
      };
      payFileStatusEl.textContent = `OK: ${file.name} (${Math.round(file.size/1024)} KB)`;
    } catch(e){
      payFileStatusEl.textContent = `Error: ${e.message}`;
      STATE.payment_proof = null;
    } finally {
      btnPreview.disabled = !isFormValid();
    }
  }

  // =====================
  // Validation
  // =====================
  function isFormValid(){
    const s = STATE.selected_slot;
    if (!s) return false;

    const disp = normalizeInt(s.cupos_disponibles);
    const qty = normalizeInt(qtyEl.value);
    if (!Number.isFinite(disp) || disp < 1) return false;
    if (!Number.isFinite(qty) || qty < 1 || qty > disp) return false;

    const participants = getParticipants();
    if (participants.length !== qty) return false;

    for (const p of participants){
      if (!p.nombres) return false;
      if (!p.apellidos) return false;
      if (!p.cedula) return false;
      if (!p.email || !isEmailBasic(p.email)) return false;
    }

    if (!isBillingValid()) return false;
    if (!isPaymentProofValid()) return false;

    return true;
  }

  // =====================
  // Payload + Preview
  // =====================
  function buildPayload(){
    return {
      meta: {
        source: "web_agendamiento",
        sent_at_iso: new Date().toISOString()
      },
      course_id: STATE.course_id,
      course: safeCourse(STATE.course),

      slot: {
        slot_id: STATE.selected_slot?.slot_id || null,
        fecha: STATE.selected_slot?.fecha || null,
        hora: STATE.selected_slot?.hora || null,
        cupos_disponibles_snapshot: STATE.selected_slot?.cupos_disponibles ?? null
      },

      reservation: {
        cantidad_personas: normalizeInt(qtyEl.value),
        participantes: getParticipants()
      },

      billing: getBilling(),

      payment_proof: STATE.payment_proof
    };
  }

  function renderPreview(payload){
    previewJsonEl.textContent = JSON.stringify(payload, null, 2);
    previewJsonEl.style.display = "block";
  }

  // =====================
  // Events
  // =====================
  btnBuild.addEventListener("click", () => buildParticipants());

  qtyEl.addEventListener("input", () => {
    const s = STATE.selected_slot;
    if (!s) return;

    const disp = normalizeInt(s.cupos_disponibles);
    let qty = normalizeInt(qtyEl.value);

    if (!Number.isFinite(qty)) qty = 1;
    if (qty < 1) qty = 1;
    if (Number.isFinite(disp) && disp > 0 && qty > disp) qty = disp;

    qtyEl.value = String(qty);

    btnPreview.disabled = !isFormValid();
    setSendMsg("");
    resetPreview();
  });

  billDocTypeEl.addEventListener("change", refreshBillingDocUI);
  [billNameEl, billDocNumberEl, billEmailEl, billPhoneEl, billAddressEl, billCityEl].forEach(el=>{
    el.addEventListener("input", ()=>{
      btnPreview.disabled = !isFormValid();
      setSendMsg("");
      resetPreview();
    });
  });

  payFileEl.addEventListener("change", async (ev)=>{
    const file = ev.target.files && ev.target.files[0] ? ev.target.files[0] : null;
    await handlePaymentFile(file);
    btnPreview.disabled = !isFormValid();
    setSendMsg("");
    resetPreview();
  });

  btnPreview.addEventListener("click", () => {
    if (!isFormValid()){
      setMsg("<span class='err'>Faltan datos obligatorios o la cantidad excede cupos disponibles o falta comprobante.</span>");
      btnConfirm.disabled = true;
      return;
    }
    const payload = buildPayload();
    STATE.last_preview_payload = payload;
    renderPreview(payload);
    setMsg("");
    setSendMsg("<span class='ok'>Vista previa generada. Verificá y luego confirmá.</span>");
    btnConfirm.disabled = false;
  });

  btnConfirm.addEventListener("click", async () => {
    if (!STATE.last_preview_payload){
      setSendMsg("<span class='err'>Primero generá la vista previa.</span>");
      return;
    }
    if (!isFormValid()){
      setSendMsg("<span class='err'>Los datos ya no son válidos. Volvé a generar la vista previa.</span>");
      btnConfirm.disabled = true;
      return;
    }

    const payload = STATE.last_preview_payload;

    btnConfirm.disabled = true;
    btnPreview.disabled = true;
    setSendMsg("<span class='muted'>Enviando…</span>");

    try{
      const res = await postReserva(payload);

      if (res.ok && res.json?.ok !== false){
        setSendMsg(`<span class='ok'>Enviado OK (HTTP ${res.status}).</span>`);
      } else {
        setSendMsg(`<span class='err'>Falló el envío (HTTP ${res.status}).</span>`);
      }

      // debug oculto; habilitalo si lo necesitás
      debugEl.style.display = "none";
      debugEl.textContent =
        `POST ${res.status}\n` +
        `URL: ${RESERVA_ENDPOINT}\n\n` +
        `${res.text}\n\n` +
        `PAYLOAD:\n${JSON.stringify(payload, null, 2)}`;

    } catch (e){
      setSendMsg(`<span class='err'>Error de red: ${htmlEscape(e?.message || String(e))}</span>`);
    } finally {
      btnPreview.disabled = !isFormValid();
      btnConfirm.disabled = true;
      STATE.last_preview_payload = null;
    }
  });

  // =====================
  // Bootstrap / Refresh polling
  // =====================
  async function loadBootstrap(courseId){
    const res = await apiGet(`${API_BASE}/api/bootstrap?course_id=${encodeURIComponent(courseId)}`);
    if (!res.ok || !res.json) return null;
    if (res.json.ok !== true) return res.json;

    STATE.course_id = courseId;
    STATE.course = res.json.course || null;
    STATE.slots = res.json.slots || [];

    renderCourse(STATE.course);
    renderSlots(STATE.slots);

    setStatus(`Listo · horarios: ${(STATE.slots||[]).length}`);
    refreshBillingDocUI();

    btnPreview.disabled = !isFormValid();
    return res.json;
  }

  async function getDebugKV(courseId){
    return apiGet(`${API_BASE}/api/debug-kv?course_id=${encodeURIComponent(courseId)}`);
  }

  async function forceRefreshAndWait(courseId){
    const before = await getDebugKV(courseId);
    const beforeTs = before?.json?.last_ingest_for_course?.ts || null;

    setStatus("Actualizando horarios…");
    const r = await apiPost(`${API_BASE}/api/refresh`, { course_id: courseId });

    if (!r.ok) {
      setStatus(`Refresh falló HTTP ${r.status}`);
      return false;
    }

    for (let i=1;i<=POLL_MAX_TRIES;i++){
      await new Promise(res=>setTimeout(res, POLL_DELAY_MS));
      const d = await getDebugKV(courseId);
      const nowTs = d?.json?.last_ingest_for_course?.ts || null;
      const exists = Boolean(d?.json?.exists);

      if (exists && nowTs && nowTs !== beforeTs) return true;
    }

    setStatus("No se detectó actualización (Zoho no ejecutó ingest a tiempo).");
    return false;
  }

  // =====================
  // Init
  // =====================
  (async function init(){
    const courseId = getCourseIdFromHash();
    if (!courseId){
      setStatus("Falta #ID=...");
      return;
    }

    setStatus("Cargando curso…");
    const boot = await loadBootstrap(courseId);

    const shouldForce = (boot?.ok !== true);
    if (shouldForce){
      const updated = await forceRefreshAndWait(courseId);
      if (updated) await loadBootstrap(courseId);
    }
  })();
</script>
</body>
</html>
