<!doctype html>
<html lang="es">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Reservas - test</title></head>
<body>
  <h1>Reservas (test)</h1>
  <div id="status"></div>
  <h2>Horarios</h2>
  <div id="slots"></div>
  <pre id="debug" style="white-space:pre-wrap;"></pre>

<script>
  const API_BASE = "https://api.taller2.workers.dev";
  const POLL_DELAY_MS = 1500;
  const POLL_MAX_TRIES = 120; // 3 min

  const statusEl = document.getElementById("status");
  const slotsEl = document.getElementById("slots");
  const debugEl = document.getElementById("debug");

  function setStatus(t){ statusEl.textContent = t; }

  function getCourseIdFromHash(){
    const h = (location.hash || "").replace(/^#/, "");
    const p = new URLSearchParams(h);
    return p.get("ID") || p.get("course_id");
  }

  async function apiGet(url){
    const r = await fetch(url, { method:"GET" });
    const t = await r.text();
    let j=null; try{ j=JSON.parse(t);}catch{}
    return {ok:r.ok, status:r.status, text:t, json:j, url};
  }

  async function apiPost(url, body){
    const r = await fetch(url, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body||{})
    });
    const t = await r.text();
    let j=null; try{ j=JSON.parse(t);}catch{}
    return {ok:r.ok, status:r.status, text:t, json:j, url};
  }

  function renderSlots(slots){
    slotsEl.innerHTML = "";
    if (!Array.isArray(slots) || slots.length === 0){
      slotsEl.innerHTML = "<em>Sin horarios</em>";
      return;
    }
    slots.forEach(s=>{
      const div=document.createElement("div");
      div.textContent = `${s.fecha} ${s.hora} - cupos ${s.cupos_disponibles} - slot ${s.slot_id}`;
      slotsEl.appendChild(div);
    });
  }

  async function loadBootstrap(courseId){
    const res = await apiGet(`${API_BASE}/api/bootstrap?course_id=${encodeURIComponent(courseId)}`);
    debugEl.textContent = `BOOTSTRAP ${res.status}\n${res.text}`;
    if (!res.ok || !res.json) return null;
    if (res.json.ok !== true) return res.json; // missing u otro
    renderSlots(res.json.slots || []);
    setStatus(`OK: horarios=${(res.json.slots||[]).length}`);
    return res.json;
  }

  async function getDebugKV(courseId){
    return apiGet(`${API_BASE}/api/debug-kv?course_id=${encodeURIComponent(courseId)}`);
  }

  async function forceRefreshAndWait(courseId){
    // antes
    const before = await getDebugKV(courseId);
    const beforeTs = before?.json?.last_ingest_for_course?.ts || null;

    setStatus("Disparando refresh…");
    const r = await apiPost(`${API_BASE}/api/refresh`, { course_id: courseId });
    debugEl.textContent = `REFRESH ${r.status}\n${r.text}`;

    if (!r.ok) {
      setStatus(`Refresh falló HTTP ${r.status}`);
      return false;
    }

    // polling hasta que cambie el ingest
    for (let i=1;i<=POLL_MAX_TRIES;i++){
      await new Promise(res=>setTimeout(res, POLL_DELAY_MS));
      const d = await getDebugKV(courseId);
      const nowTs = d?.json?.last_ingest_for_course?.ts || null;
      const exists = Boolean(d?.json?.exists);

      setStatus(`Esperando actualización… (${i}/${POLL_MAX_TRIES}) ts=${nowTs||"null"} exists=${exists}`);

      if (exists && nowTs && nowTs !== beforeTs) return true;
    }

    setStatus("No se detectó actualización (Zoho no ejecutó ingest a tiempo).");
    return false;
  }

  (async function init(){
    const courseId = getCourseIdFromHash();
    if (!courseId){
      setStatus("Falta #ID=...");
      return;
    }

    // 1) intento cargar lo que haya
    const boot = await loadBootstrap(courseId);

    // 2) si falta o querés siempre “último estado”, forzar refresh
    // si querés que siempre actualice, dejá esta condición como TRUE.
    const shouldForce = (boot?.ok !== true); // solo si missing
    // const shouldForce = true; // <-- si querés SIEMPRE forzar

    if (shouldForce){
      const updated = await forceRefreshAndWait(courseId);
      if (updated) await loadBootstrap(courseId);
    }
  })();
</script>
</body>
</html>
