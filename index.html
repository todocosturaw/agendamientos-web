<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Test Horarios (Worker)</title>
</head>
<body>
  <h1>Test: Ver horarios desde Worker</h1>

  <p>
    Course ID:
    <input id="courseId" style="width:360px" value="4537469000000223003" />
  </p>

  <p>
    <button id="btnVer">Ver horarios</button>
    <button id="btnBootstrap">Abrir bootstrap (JSON)</button>
  </p>

  <div id="status"></div>
  <hr />

  <h2>Curso</h2>
  <div id="curso"></div>

  <h2>Horarios</h2>
  <form id="formSlots">
    <div id="slots"></div>
  </form>

  <p>
    <button id="btnContinuar" disabled>Continuar con horario seleccionado</button>
  </p>

  <pre id="debug" style="white-space:pre-wrap;"></pre>

  <script>
    const API_BASE = "https://api.taller2.workers.dev";

    const $ = (id) => document.getElementById(id);
    const courseIdEl = $("courseId");
    const btnVer = $("btnVer");
    const btnBootstrap = $("btnBootstrap");
    const btnContinuar = $("btnContinuar");

    const statusEl = $("status");
    const cursoEl = $("curso");
    const slotsEl = $("slots");
    const debugEl = $("debug");

    let selectedSlot = null;
    let lastJson = null;

    function setStatus(t){ statusEl.textContent = t; }
    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    async function getBootstrap(courseId){
      const url = `${API_BASE}/api/bootstrap?course_id=${encodeURIComponent(courseId)}`;
      const r = await fetch(url, { method: "GET" });
      const text = await r.text();
      let json = null;
      try { json = JSON.parse(text); } catch {}
      return { ok: r.ok, status: r.status, text, json, url };
    }

    function renderCurso(course){
      if (!course) { cursoEl.innerHTML = "<em>Sin datos</em>"; return; }
      cursoEl.innerHTML = `
        <div><strong>${escapeHtml(course.nombre_curso || "Curso")}</strong></div>
        <div>Plataforma: ${escapeHtml(course.plataforma || "")}</div>
        <div>Alumnado: ${escapeHtml(course.alumnado || "")}</div>
        <div>Aprendizaje: ${escapeHtml(course.tipo_aprendizaje || "")}</div>
        <div>Categoría: ${escapeHtml(course.categoria || "")}</div>
        <div>Precio: ${escapeHtml(course.precio || "")}</div>
      `;
    }

    function renderSlots(slots){
      selectedSlot = null;
      btnContinuar.disabled = true;
      slotsEl.innerHTML = "";

      if (!Array.isArray(slots) || slots.length === 0){
        slotsEl.innerHTML = "<em>No hay horarios (o todavía no está cacheado en KV).</em>";
        return;
      }

      slots.forEach((s, i) => {
        const available = Number(s.cupos_disponibles || 0) > 0;
        const disabled = available ? "" : "disabled";
        const label = `${s.fecha} ${s.hora} — cupos: ${s.cupos_disponibles} — slot_id: ${s.slot_id}`;

        const row = document.createElement("div");
        row.style.margin = "6px 0";
        row.innerHTML = `
          <label>
            <input type="radio" name="slot" value="${escapeHtml(s.slot_id)}" ${disabled} />
            ${escapeHtml(label)} ${available ? "" : "(AGOTADO)"}
          </label>
        `;

        const input = row.querySelector("input");
        input.addEventListener("change", () => {
          selectedSlot = s;
          btnContinuar.disabled = false;
          setStatus(`Seleccionado: ${s.fecha} ${s.hora} (slot_id ${s.slot_id})`);
        });

        slotsEl.appendChild(row);
      });
    }

    async function verHorarios(){
      const courseId = courseIdEl.value.trim();
      if (!courseId){ setStatus("Falta course_id"); return; }

      setStatus("Cargando...");
      const res = await getBootstrap(courseId);

      debugEl.textContent = `GET ${res.url}\nHTTP ${res.status}\n\n${res.text}`;

      if (!res.ok || !res.json){
        setStatus(`Error leyendo bootstrap (HTTP ${res.status})`);
        return;
      }

      lastJson = res.json;

      if (res.json.ok !== true){
        if (res.json.status === "missing"){
          setStatus("Todavía no hay datos cacheados (status=missing). Ejecutá el ingest desde Zoho/Flow o manual.");
        } else {
          setStatus("Respuesta inválida");
        }
        renderCurso(null);
        renderSlots([]);
        return;
      }

      renderCurso(res.json.course);
      renderSlots(res.json.slots || []);
      setStatus(`Listo. Horarios: ${(res.json.slots || []).length}`);
    }

    btnVer.addEventListener("click", verHorarios);

    btnBootstrap.addEventListener("click", () => {
      const courseId = courseIdEl.value.trim();
      if (!courseId) return;
      const url = `${API_BASE}/api/bootstrap?course_id=${encodeURIComponent(courseId)}`;
      window.open(url, "_blank");
    });

    btnContinuar.addEventListener("click", () => {
      if (!selectedSlot){
        setStatus("Seleccioná un horario primero.");
        return;
      }
      alert(`OK: horario seleccionado\n\ncourse_id=${courseIdEl.value.trim()}\nslot_id=${selectedSlot.slot_id}\nfecha=${selectedSlot.fecha}\nhora=${selectedSlot.hora}`);
    });

    // auto-carga al abrir
    verHorarios();
  </script>
</body>
</html>
